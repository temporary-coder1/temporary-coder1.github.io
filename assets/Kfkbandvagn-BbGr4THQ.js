import{A as Ve,G as pt,H as gt,B as re,_ as ke,r as M,j as R,o as Se,c as y,h as g,C as ye,D as yt,b as a,e as D,z as ue,t as w,s as ce,f as Be,v as Ye,F as me,p as be,x as ve,y as q,I as mt,w as Ce,k as We,n as bt,E as Ge,d as J}from"./index-BP2jq8xO.js";class de extends Error{code;status;constructor(o,s,n){super(o),this.name="BandvagnAPIError",this.code=s,this.status=n}}async function fe(e,o="GET",s){console.log("Making request to endpoint:",e,"with method:",o,"and body:",s);try{const n={method:o};s&&(n.body=s);const{data:c,error:k}=await Ve.functions.invoke(`kfkbandvagn${e}`,n);if(console.log("Response data:",c,"Error:",k),k)throw console.error("Edge Function error:",k),new de(k.message||"Request failed",k.name,k.status);if(c&&typeof c=="object"){if("success"in c&&c.success===!1){const h=c;throw new de(h.error?.message||h.message||"Request failed",h.error?.code)}return"data"in c?c.data:c}return c}catch(n){throw n instanceof de?n:(console.error("API request failed:",n),new de(n instanceof Error?n.message:"Unknown API error"))}}function Xe(e){return e instanceof de?{no_player_found:"Ingen spelare hittades",no_free_tanks:"Inga lediga tanks",missing_tokens:"Inte nog med tokens",invalid_action:"Ogiltigt drag",not_in_range:"Inte inom räckvidd",player_already_dead:"Spelaren är redan död",invalid_session:"Session har gått ut, logga in igen",validation_error:"Ogiltiga data",internal_error:"Serverfel, försök igen"}[e.code||""]||e.message||"Ett fel uppstod":e instanceof Error?e.message:"Ett oväntat fel uppstod"}async function je(){return fe("/game/state","GET",void 0)}async function kt(){return fe("/game/stats","GET",void 0)}const _t=Object.freeze(Object.defineProperty({__proto__:null,getGameState:je,getGameStats:kt},Symbol.toStringTag,{value:"Module"}));async function wt(e){return fe("/auth/create","POST",e)}async function Pt(e){return fe("/auth/login","POST",e)}async function Mt(e){return console.log("performGameAction called with action:",e),fe("/game/action","POST",e)}const De=pt("bandvagn",{state:()=>({allPlayers:[],currentPlayer:null,boardData:null,initialized:!1,isLoading:!1,error:null,lastFetch:null,selectedCell:null,autoRefreshEnabled:!0,refreshInterval:36e5,refreshTimeoutId:null}),getters:{isPlayerAlive:e=>(e.currentPlayer?.lives||0)>0,canAffordUpgrade:e=>o=>(e.currentPlayer?.tokens||0)>=o,boardSize:e=>e.boardData?{rows:e.boardData.rows,cols:e.boardData.cols}:{rows:0,cols:0},playableBoardSize:e=>{if(!e.boardData)return{rows:0,cols:0};const o=e.boardData.shrink||0;return{rows:Math.max(1,e.boardData.rows-o*2),cols:Math.max(1,e.boardData.cols-o*2)}},recentLogs:e=>e.boardData?.logs?.slice(-20)||[],otherPlayers:e=>e.allPlayers.filter(o=>o.uuid!==e.currentPlayer?.uuid&&o.taken_tank),isDataFresh:e=>e.lastFetch?new Date().getTime()-e.lastFetch.getTime()<3e4:!1,gameStats:e=>{const o=e.allPlayers.filter(n=>n.lives>0&&n.taken_tank).length,s=e.allPlayers.filter(n=>n.taken_tank).length;return{alivePlayers:o,totalPlayers:s,boardShrink:e.boardData?.shrink||0}}},actions:{async initialize(){if(console.log("Initializing bandvagn store"),this.initialized){console.log("Bandvagn store already initialized, skipping");return}if(!re().isAuthed){console.warn("Cannot initialize bandvagn store - user not authenticated");return}this.isLoading=!0,this.error=null;try{await this.fetchGameState(),this.initialized=!0,this.autoRefreshEnabled&&this.startAutoRefresh(),console.log("Bandvagn store initialized successfully")}catch(o){console.error("Failed to initialize bandvagn store:",o),this.error=o instanceof Error?o.message:"Initialization failed"}finally{this.isLoading=!1}},async fetchGameState(){this.isLoading=!0,this.error=null;try{console.log("Fetching game state from server...");const e=await je();this.allPlayers=e.playerData||[],e.boardData&&(this.boardData={rows:e.boardData.size.rows,cols:e.boardData.size.columns,shrink:e.boardData.shrink,logs:e.boardData.logs,upgrades:e.boardData.upgrades||[],time_to_shrink:e.boardData.time_to_shrink||""}),await this.fetchCurrentUserTank(),this.lastFetch=new Date,console.log("Game state updated:",{players:this.allPlayers.length,currentPlayer:!!this.currentPlayer,boardSize:this.boardSize})}catch(e){throw console.error("Failed to fetch game state:",e),this.error=e instanceof Error?e.message:"Failed to fetch game state",e}finally{this.isLoading=!1}},async fetchCurrentUserTank(){const e=re();if(!e.user?.id)return this.currentPlayer=null,null;try{const{data:o,error:s}=await Ve.from("KfKbandvagn").select("user_id, playerID, uuid, tokens, position, lives, range, color, taken_tank").eq("user_id",e.user.id).maybeSingle();return s?(console.error("Failed to fetch current user's tank:",s),this.currentPlayer=null,null):!o||o.taken_tank===!1?(this.currentPlayer=null,null):(this.currentPlayer={uuid:o.uuid,playerID:o.playerID,position:o.position,lives:o.lives,tokens:o.tokens,range:o.range,taken_tank:o.taken_tank,color:o.color},this.currentPlayer)}catch(o){return console.error("Unexpected error fetching current user's tank:",o),this.currentPlayer=null,null}},async createPlayer(e){const o=re();if(!o.user?.id)throw new Error("User not authenticated");this.isLoading=!0,this.error=null;try{const s=await wt({user_id:o.user.id,playerID:e.playerID,color:e.color});return await this.fetchGameState(),s}catch(s){throw console.error("Failed to create player:",s),this.error=s instanceof Error?s.message:"Failed to create player",s}finally{this.isLoading=!1}},async loginPlayer(){const e=re();if(!e.user?.id)throw new Error("User not authenticated");this.isLoading=!0,this.error=null;try{const o=await Pt({user_id:e.user.id});return await this.fetchGameState(),o}catch(o){throw console.error("Failed to login player:",o),this.error=o instanceof Error?o.message:"Failed to login player",o}finally{this.isLoading=!1}},async performAction(e){this.isLoading=!0,this.error=null;try{const o={action:e.action,tank_id:e.tank_id};e.action==="move"&&e.targetCell&&(o.moveDirection={row:e.targetCell.row,col:e.targetCell.col}),e.action==="shot"&&e.targetUUID&&(o.targetUUID=e.targetUUID),console.log("Performing action:",o);const s=await Mt(o);if(console.log("Action result:",s),e.action==="shot"&&e.animationTrigger?.triggerBulletAndExplosion&&e.targetUUID&&this.currentPlayer){const n=this.allPlayers.find(c=>c.uuid===e.targetUUID);if(n){const c=this.currentPlayer.position,k=n.position;this.currentPlayer=s.updatedData;const h=this.allPlayers.findIndex(i=>i.uuid===s.updatedData.uuid);return h!==-1&&(this.allPlayers[h]=s.updatedData),e.animationTrigger.triggerBulletAndExplosion(c.row,c.column,k.row,k.column,()=>{if(s.shotData){const i=this.allPlayers.findIndex(_=>_.uuid===e.targetUUID);i!==-1&&(this.allPlayers[i]=s.shotData)}s.updatedLogs&&this.boardData&&(Array.isArray(s.updatedLogs)?this.boardData.logs=s.updatedLogs:this.boardData.logs=[...this.boardData.logs,s.updatedLogs])}),s}}if(e.action==="move"&&this.currentPlayer){if(s.updatedData){const n=this.allPlayers.findIndex(c=>c.uuid===s.updatedData.uuid);n!==-1&&(this.allPlayers[n]=s.updatedData),this.currentPlayer=s.updatedData}return s.updatedLogs&&this.boardData&&(Array.isArray(s.updatedLogs)?this.boardData.logs=s.updatedLogs:this.boardData.logs=[...this.boardData.logs,s.updatedLogs]),e.animationTrigger?.triggerTankMove&&e.animationTrigger.triggerTankMove(),s}if(e.action!=="shot"&&s.updatedData){const n=this.allPlayers.findIndex(c=>c.uuid===s.updatedData?.uuid);n!==-1&&(this.allPlayers[n]=s.updatedData),this.currentPlayer=s.updatedData,s.updatedLogs&&this.boardData&&(Array.isArray(s.updatedLogs)?this.boardData.logs=s.updatedLogs:this.boardData.logs=[...this.boardData.logs,s.updatedLogs])}return console.log("Game state refreshed successfully."),s}catch(o){throw console.error("Action failed:",o),this.error=o instanceof Error?o.message:"Action failed",o}finally{this.isLoading=!1}},async fetchGameStats(){try{const{getGameStats:e}=await gt(async()=>{const{getGameStats:s}=await Promise.resolve().then(()=>_t);return{getGameStats:s}},void 0);return await e()}catch(e){throw console.error("Failed to fetch game stats:",e),e}},startAutoRefresh(){this.refreshTimeoutId&&clearTimeout(this.refreshTimeoutId),this.refreshTimeoutId=window.setTimeout(async()=>{if(this.autoRefreshEnabled&&this.initialized){try{await this.fetchGameState()}catch(e){console.error("Auto-refresh failed:",e)}this.startAutoRefresh()}},this.refreshInterval)},stopAutoRefresh(){this.refreshTimeoutId&&(clearTimeout(this.refreshTimeoutId),this.refreshTimeoutId=null)},async forceRefresh(){this.lastFetch=null,await this.fetchGameState()},selectCell(e){this.selectedCell=e},canMoveToCell(e,o){if(!this.currentPlayer||(this.playableBoardSize,this.boardData?.shrink,e<0||e>=this.boardSize.rows||o<0||o>=this.boardSize.cols)||this.allPlayers.some(k=>k.position.row===e&&k.position.column===o&&k.lives>0&&k.uuid!==this.currentPlayer?.uuid)||this.currentPlayer.position.row===e&&this.currentPlayer.position.column===o)return!1;const n=Math.abs(e-this.currentPlayer.position.row)+Math.abs(o-this.currentPlayer.position.column),c=Math.max(1,n);return this.currentPlayer.tokens>=c},canShootAtCell(e,o){if(!this.currentPlayer||!this.allPlayers.find(c=>c.position.row===e&&c.position.column===o&&c.uuid!==this.currentPlayer?.uuid&&c.taken_tank&&c.lives>0))return!1;const n=Math.abs(e-this.currentPlayer.position.row)+Math.abs(o-this.currentPlayer.position.column);return n<=this.currentPlayer.range&&n>0},clearError(){this.error=null},setAutoRefresh(e){this.autoRefreshEnabled=e,e&&this.initialized?this.startAutoRefresh():this.stopAutoRefresh()},reset(){this.stopAutoRefresh(),this.allPlayers=[],this.currentPlayer=null,this.boardData=null,this.initialized=!1,this.isLoading=!1,this.error=null,this.lastFetch=null,this.selectedCell=null}}}),Ct={class:"player-creation-container"},St={key:1,class:"modal-overlay"},Dt={class:"modal-content"},At={class:"player-creation-form"},$t={key:0,class:"user-greeting"},Tt={key:1,class:"auth-prompt"},It={class:"button-group auth-buttons"},xt={class:"form-group"},Rt=["disabled"],Ft={class:"form-group"},Et={class:"color-picker-container"},Lt=["disabled"],Ut={class:"color-value"},Bt=["disabled"],Yt={class:"preset-colors"},Gt={class:"color-presets"},Xt=["onClick","disabled"],Kt={key:0,class:"error-message"},zt={key:1,class:"loading-state"},Ot={key:2,class:"button-group"},Vt={key:3,class:"existing-player-option"},Wt=["disabled"],jt={__name:"PlayerCreation",emits:["close","playerCreated"],setup(e,{emit:o}){const s=re(),n=De(),c=M(""),k=M("#4CAF50"),h=M(!1),i=M(""),_=M(!1),P=M(""),l=M(!0),S=["#4CAF50","#2196F3","#FF5722","#FF9800","#9C27B0","#607D8B","#795548","#E91E63","#00BCD4","#8BC34A","#FFC107","#3F51B5"],C=o;function x(L){P.value=L,_.value=!0}function F(){_.value=!1,P.value=""}function A(){_.value=!1,P.value="",s.fetchProfile()}const T=R(()=>c.value.length>=2&&c.value.length<=20&&/^[a-zA-Z0-9åäöÅÄÖ\s\-_.]*$/.test(c.value)&&/^#[0-9A-Fa-f]{6}$/.test(k.value));async function oe(){if(!T.value){i.value="Kontrollera att alla fält är korrekt ifyllda";return}if(!s.isAuthed){i.value="Du måste vara inloggad för att skapa en spelare";return}h.value=!0,i.value="";try{await n.createPlayer({playerID:c.value.trim(),color:k.value}),console.log("Player created successfully"),C("playerCreated")}catch(L){console.error("Failed to create player:",L),i.value=Xe(L)}finally{h.value=!1}}async function O(){if(!s.isAuthed){i.value="Du måste vara inloggad";return}h.value=!0,i.value="";try{await n.loginPlayer(),console.log("Player logged in successfully"),C("playerCreated")}catch(L){console.error("Failed to login existing player:",L),i.value=Xe(L),L.code==="no_player_found"&&(l.value=!1)}finally{h.value=!1}}function V(){C("close")}function X(){const L=`#${Math.floor(Math.random()*16777215).toString(16).padStart(6,"0")}`;k.value=L}return Se(()=>{if(X(),s.isAuthed&&s.profile?.username)c.value=s.profile.username;else if(s.user?.email){const L=s.user.email.split("@")[0];c.value=L.substring(0,15)}}),(L,b)=>(g(),y("div",Ct,[_.value?(g(),ye(yt,{key:0,mode:P.value,onClose:F,onSuccess:A,class:"auth-form"},null,8,["mode"])):(g(),y("div",St,[a("div",Dt,[a("div",At,[a("button",{type:"button",class:"close-form-button",onClick:V},"×"),b[15]||(b[15]=a("h2",null,"Skapa din Bandvagn",-1)),ue(s).isAuthed?(g(),y("div",$t,[a("p",null,"Hej "+w(ue(s).profile?.username||ue(s).user?.email)+"!",1),b[4]||(b[4]=a("p",null,"Skapa din bandvagn för att börja spela.",-1))])):(g(),y("div",Tt,[b[5]||(b[5]=a("p",null,"Du behöver vara inloggad för att spela KfKbandvagn.",-1)),a("div",It,[a("button",{onClick:b[0]||(b[0]=B=>x("login")),class:"button-base"},"Logga In"),a("button",{onClick:b[1]||(b[1]=B=>x("signup")),class:"button-base"},"Skapa Konto")])])),ue(s).isAuthed?(g(),y("form",{key:2,onSubmit:ce(oe,["prevent"]),class:"creation-form"},[a("div",xt,[b[6]||(b[6]=a("label",{for:"playerID",class:"form-label"},"Spelarnamn",-1)),Be(a("input",{"onUpdate:modelValue":b[2]||(b[2]=B=>c.value=B),type:"text",id:"playerID",class:"form-input",placeholder:"Ange ditt spelarnamn",disabled:h.value,required:"",minlength:"2",maxlength:"20"},null,8,Rt),[[Ye,c.value]]),b[7]||(b[7]=a("small",{class:"input-help"},"2-20 tecken, inga specialtecken",-1))]),a("div",Ft,[b[8]||(b[8]=a("label",{for:"playerColor",class:"form-label"},"Bandvagnsfärg",-1)),a("div",Et,[Be(a("input",{"onUpdate:modelValue":b[3]||(b[3]=B=>k.value=B),type:"color",id:"playerColor",class:"color-input",disabled:h.value},null,8,Lt),[[Ye,k.value]]),a("span",Ut,w(k.value),1),a("button",{type:"button",class:"random-color-btn",onClick:X,disabled:h.value,title:"Slumpa färg"}," 🎲 ",8,Bt)]),b[9]||(b[9]=a("small",{class:"input-help"},"Välj en färg för din bandvagn eller slumpa en",-1))]),a("div",Yt,[b[10]||(b[10]=a("label",{class:"form-label"},"Förvalda färger:",-1)),a("div",Gt,[(g(),y(me,null,be(S,B=>a("button",{key:B,type:"button",class:q(["preset-color-btn",{active:k.value===B}]),style:ve({backgroundColor:B}),onClick:H=>k.value=B,disabled:h.value},null,14,Xt)),64))])]),i.value?(g(),y("div",Kt,w(i.value),1)):D("",!0),h.value?(g(),y("div",zt,[...b[11]||(b[11]=[a("div",{class:"loading-spinner"},"⏳",-1),a("p",null,"Skapar din bandvagn...",-1)])])):D("",!0),h.value?D("",!0):(g(),y("div",Ot,[a("button",{type:"button",onClick:V,class:"button-base decline"},"Avbryt"),b[12]||(b[12]=a("button",{type:"submit",class:"button-base"},"Skapa Bandvagn",-1))]))],32)):D("",!0),ue(s).isAuthed&&l.value?(g(),y("div",Vt,[b[13]||(b[13]=a("hr",{class:"divider"},null,-1)),b[14]||(b[14]=a("p",null,"Eller om du redan har en bandvagn:",-1)),a("button",{onClick:O,class:"button-base",disabled:h.value}," Logga in befintlig spelare ",8,Wt)])):D("",!0)])])]))]))}},qt=ke(jt,[["__scopeId","data-v-917e64e0"]]),Ht={class:"popup-header"},Nt={key:0,class:"players-section"},Zt={class:"player-list"},Jt={class:"player-info"},Qt={class:"player-name"},ea={class:"player-stats"},ta={class:"action-buttons"},aa={key:0,class:"action-option"},sa=["disabled"],na={class:"btn-cost"},oa={key:1,class:"action-option"},la={key:0},ra=["disabled"],ia={class:"btn-text"},ua={key:2,class:"no-actions"},ca={key:0},da={key:1},va={key:2},fa={key:3},ha={key:4},pa={key:5},ga={class:"info-section"},ya={class:"distance-info"},ma={key:0},ba={class:"cell-type-info"},ka={key:0,class:"status-danger"},_a={__name:"GamePopup",props:{cell:{type:Object,required:!0,validator:e=>e&&typeof e.row=="number"&&typeof e.col=="number"},currentPlayer:{type:Object,default:null},otherPlayers:{type:Array,default:()=>[]},canMove:{type:Boolean,default:!1},canShoot:{type:Boolean,default:!1},position:{type:Object,default:()=>({x:0,y:0})}},emits:["action","close"],setup(e,{emit:o}){const s=e,n=o,c=M(!1),k=R(()=>({left:`${s.position.x}px`,top:`${s.position.y}px`})),h=R(()=>s.otherPlayers.filter(F=>F.lives>0)),i=R(()=>!s.currentPlayer||!s.cell?0:Math.abs(s.cell.row-s.currentPlayer.position.row)+Math.abs(s.cell.col-s.currentPlayer.position.column)),_=R(()=>Math.max(1,i.value)),P=R(()=>s.currentPlayer?s.currentPlayer.tokens>=_.value:!1),l=R(()=>s.currentPlayer?s.currentPlayer.tokens>=1:!1),S=R(()=>!0),C=R(()=>s.otherPlayers.some(F=>F.taken_tank));async function x(F,A=null){if(c.value){console.log("Action already in progress, ignoring click");return}c.value=!0;try{const T={action:F,tank_id:s.currentPlayer?.uuid||"",targetCell:F==="move"?{row:s.cell.row,col:s.cell.col}:void 0,targetUUID:A};await n("action",T)}catch(T){console.error("Error performing action:",T)}finally{setTimeout(()=>{c.value=!1},1e3)}}return(F,A)=>e.cell?(g(),y("div",{key:0,class:"game-popup",style:ve(k.value)},[a("button",{class:"popup-close",onClick:A[0]||(A[0]=T=>F.$emit("close"))},"×"),a("div",Ht,[a("h4",null,"Cell ("+w(e.cell.row)+", "+w(e.cell.col)+")",1)]),e.otherPlayers.length>0?(g(),y("div",Nt,[a("div",Zt,[(g(!0),y(me,null,be(e.otherPlayers,T=>(g(),y("div",{key:T.uuid,class:q(["player-item",{dead:T.lives<=0}])},[a("div",{class:"player-color",style:ve({backgroundColor:T.color})},null,4),a("div",Jt,[a("span",Qt,w(T.playerID),1),a("span",ea,w(T.lives)+" liv, "+w(T.tokens)+" tokens",1)])],2))),128))])])):D("",!0),a("div",ta,[e.canMove?(g(),y("div",aa,[a("button",{onClick:A[1]||(A[1]=T=>x("move")),class:q(["action-btn move-btn",{disabled:!P.value||c.value}]),disabled:!P.value||c.value},[A[3]||(A[3]=a("span",{class:"btn-icon"},"🚶‍♂️",-1)),A[4]||(A[4]=a("span",{class:"btn-text"},"Flytta Hit",-1)),a("span",na,w(_.value)+" token"+w(_.value>1?"s":""),1)],10,sa)])):D("",!0),e.canShoot&&h.value.length>0?(g(),y("div",oa,[h.value.length===1?(g(),y("div",la,[a("button",{onClick:A[2]||(A[2]=T=>x("shot",h.value[0].uuid)),class:q(["action-btn shoot-btn",{disabled:!l.value||c.value}]),disabled:!l.value||c.value},[A[5]||(A[5]=a("span",{class:"btn-icon"},"🎯",-1)),a("span",ia,"Skjut "+w(h.value[0].playerID),1),A[6]||(A[6]=a("span",{class:"btn-cost"},"1 token",-1))],10,ra)])):D("",!0)])):D("",!0),!e.canMove&&!e.canShoot?(g(),y("div",ua,[e.currentPlayer?e.currentPlayer.lives<=0?(g(),y("p",da,"Du är död och kan inte utföra handlingar")):!P.value&&i.value>0?(g(),y("p",va," Du har inte råd att flytta hit ("+w(_.value)+" tokens behövs, du har "+w(e.currentPlayer.tokens)+") ",1)):C.value&&e.otherPlayers.length===0?(g(),y("p",fa," Du kan inte flytta till din egen position ")):C.value?(g(),y("p",ha,"Cell upptagen av annan spelare")):(g(),y("p",pa,"Ingen giltig handling")):(g(),y("p",ca,"Du måste vara inloggad för att spela"))])):D("",!0)]),a("div",ga,[a("div",ya,[a("span",null,"Avstånd: "+w(i.value),1),e.currentPlayer&&e.otherPlayers.length>0?(g(),y("span",ma,"Räckvidd: "+w(e.currentPlayer.range),1)):D("",!0)]),a("div",ba,[S.value?D("",!0):(g(),y("span",ka,"⚠️ Avstängd zon"))])])],4)):D("",!0)}},wa=ke(_a,[["__scopeId","data-v-d0d0ac49"]]);function Pa(e,o,s,n="explosion",c){const k=[],h=n==="explosion"?25:10,i=["#FFD700","#FF4500","#FF6347","#DC143C","#8B0000","#000000"];for(let P=0;P<h;P++){const l=Math.random()*Math.PI*2,S=s*(.07+Math.random()*.16);k.push({x:0,y:0,vx:Math.cos(l)*S,vy:Math.sin(l)*S,size:Math.max(2,s*.08+Math.random()*(s*.06)),color:i[Math.floor(Math.random()*i.length)]||"#FF4500",life:1,maxLife:400+Math.random()*300})}const _={row:e,col:o,type:n,particles:k,active:!0,duration:800,elapsed:0};return c&&(_.onComplete=c),_}function Ma(e,o,s,n,c="click"){const k=[];for(let i=0;i<50;i++){const _=i/50*Math.PI*2+(Math.random()-.5)*.5,P=s*(.06+Math.random()*.16);k.push({x:0,y:0,vx:Math.cos(_)*P,vy:Math.sin(_)*P,size:Math.max(1.5,s*.06+Math.random()*(s*.04)),color:n,life:1,maxLife:300+Math.random()*250})}return{row:e,col:o,type:c,particles:k,active:!0,duration:350,elapsed:0,rippleRadius:0,rippleMaxRadius:Math.max(s*.9,14),rippleAlpha:1,playerColor:n}}function Ca(e,o,s,n,c){const k=Math.sqrt(Math.pow(s-e,2)+Math.pow(n-o,2)),i=12/Math.max(1,k),_={startX:e,startY:o,endX:s,endY:n,currentX:e,currentY:o,progress:0,active:!0,speed:i};return c&&(_.onComplete=c),_}function Sa(e,o,s,n,c,k=2){return{startRow:e,startCol:o,endRow:s,endCol:n,currentRow:e,currentCol:o,tankUuid:c,phase:e!==s?"row":"col",progress:0,active:!0,speed:k}}function Da(e,o){if(!e.active)return e;const s=e.active;return e.elapsed+=o,e.particles.forEach(n=>{n.x+=n.vx,n.y+=n.vy,n.life-=o/n.maxLife,n.vy+=.001*o,n.vx*=.98,n.vy*=.98}),e.particles=e.particles.filter(n=>n.life>0),(e.elapsed>=e.duration||e.particles.length===0)&&(e.active=!1,s&&e.onComplete&&e.onComplete()),e}function Aa(e,o){if(!e.active)return e;e.elapsed+=o;const s=e.elapsed/e.duration;if(s>=1)return e.active=!1,e;const n=1-Math.pow(1-s,3);return e.rippleRadius=n*e.rippleMaxRadius,e.rippleAlpha=1-n,e.particles.forEach(c=>{c.life-=o/c.maxLife,c.x+=c.vx,c.y+=c.vy,c.vx*=.985,c.vy*=.985}),e.particles=e.particles.filter(c=>c.life>0),e}function $a(e,o){if(!e.active)return e;const s=e.progress>=1;return e.progress+=e.speed*o*.01,e.progress>=1&&(e.progress=1,e.active=!1,!s&&e.onComplete&&e.onComplete()),e.currentX=e.startX+(e.endX-e.startX)*e.progress,e.currentY=e.startY+(e.endY-e.startY)*e.progress,e}function Ta(e,o){if(!e.active)return e;e.progress>=1&&e.phase==="col"&&(e.currentRow,e.endRow);const s=e.speed*o*.001;if(e.phase==="row"){const n=Math.abs(e.endRow-e.startRow);n===0?(e.phase="col",e.progress=0):(e.progress+=s/n,e.progress>=1?(e.progress=1,e.currentRow=e.endRow,e.endCol!==e.startCol?(e.phase="col",e.progress=0):e.active=!1):e.currentRow=e.startRow+(e.endRow-e.startRow)*e.progress)}else if(e.phase==="col"){const n=Math.abs(e.endCol-e.startCol);n===0?e.active=!1:(e.progress+=s/n,e.progress>=1?(e.progress=1,e.currentCol=e.endCol,e.active=!1):e.currentCol=e.startCol+(e.endCol-e.startCol)*e.progress)}return e}function Ke(){return{explosions:[],bullets:[],clicks:[],tankMoves:[],lastUpdate:performance.now()}}function Ia(e,o=performance.now()){const s=o-e.lastUpdate;return e.explosions=e.explosions.map(n=>Da(n,s)).filter(n=>n.active),e.clicks=e.clicks.map(n=>Aa(n,s)).filter(n=>n.active),e.bullets=e.bullets.map(n=>$a(n,s)).filter(n=>n.active),e.tankMoves=e.tankMoves.map(n=>Ta(n,s)).filter(n=>n.active),e.lastUpdate=o,e}function xa(e,o,s,n,c="explosion",k){return he(e)||(e.lastUpdate=performance.now()),e.explosions.push(Pa(o,s,n,c,k)),e}function Ra(e,o,s,n,c){return he(e)||(e.lastUpdate=performance.now()),e.clicks.push(Ma(o,s,n,c)),e}function Fa(e,o,s,n,c,k=.05,h){return he(e)||(e.lastUpdate=performance.now()),e.bullets.push(Ca(o,s,n,c,h)),e}function Ea(e,o,s,n,c,k,h=2){return he(e)||(e.lastUpdate=performance.now()),e.tankMoves.push(Sa(o,s,n,c,k,h)),e}function he(e){return e.explosions.length>0||e.bullets.length>0||e.clicks.length>0||e.tankMoves.length>0}function La(e,o,s,n,c,k){o.explosions.forEach(h=>{const i=(h.col+.5)*s,_=(h.row+.5)*s;h.particles.forEach(P=>{const l=i+P.x,S=_+P.y,C=(l+c)*n,x=(S+k)*n,F=P.size*n*(.85+.35*P.life);e.save(),e.globalAlpha=Math.max(0,Math.min(1,P.life)),e.fillStyle=P.color,e.beginPath(),e.arc(C,x,F,0,Math.PI*2),e.fill(),e.restore()})}),o.clicks.forEach(h=>{const i=(h.col+.5)*s,_=(h.row+.5)*s;if(h.rippleAlpha>0){const P=(i+c)*n,l=(_+k)*n,S=h.rippleRadius*n;e.save(),e.strokeStyle=`rgba(224, 59, 75, ${Math.max(0,Math.min(.9,h.rippleAlpha))})`,e.lineWidth=Math.max(1,h.rippleAlpha*4),e.beginPath(),e.arc(P,l,S,0,Math.PI*2),e.stroke(),e.restore()}h.particles.forEach(P=>{const l=i+P.x,S=_+P.y,C=(l+c)*n,x=(S+k)*n,F=P.size*n*(.85+.35*P.life);e.save(),e.globalAlpha=Math.max(0,Math.min(1,P.life)),e.fillStyle=P.color,e.beginPath(),e.arc(C,x,F,0,Math.PI*2),e.fill(),e.restore()})}),o.bullets.forEach(h=>{const i=(h.currentX+c)*n,_=(h.currentY+k)*n,P=Math.max(2,s*.1)*n;e.save(),e.fillStyle="#000000",e.beginPath(),e.arc(i,_,P,0,Math.PI*2),e.fill(),e.restore()})}function Ua(e,o){const s=e.tankMoves.find(n=>n.tankUuid===o&&n.active);return s?{row:s.currentRow,col:s.currentCol}:null}const Ba={class:"canvas-controls"},Ya={key:1,class:"loading-overlay"},ze=4,Oe=16/24,Ga=mt({__name:"BandvagnCanvas",emits:["actionPerformed"],setup(e,{expose:o,emit:s}){const n=De(),c=s,k=M(null),h=M(null),i=M(null),_=M(800),P=M(600),l=M(30),S=M(1),C=M({x:0,y:0}),x=M(!1),F=M(!1),A=M(!1),T=M({x:0,y:0}),oe=M(!1),O=M(window.devicePixelRatio||1),V=M(null),X=M(!1),L=M({x:0,y:0}),b=M(null),B=M(0),H=M(!1),U=M(Ke());let W=null,j=0;const N=M({bg:"#000",grid:"#333",text:"#444",modalHeader:"#ff6"}),Q=M("12px Arial, sans-serif");function ee(){const t=k.value??document.documentElement,u=getComputedStyle(t);N.value={bg:u.getPropertyValue("--canvas-bg-color").trim()||"#000",grid:u.getPropertyValue("--canvas-grid-color").trim()||"#333",text:u.getPropertyValue("--canvas-text-color").trim()||"#444",modalHeader:u.getPropertyValue("--modal-header-color").trim()||"#ff6"};const v=u.getPropertyValue("--theme-font-family").trim()||"Arial, sans-serif",r=Math.max(10,Math.floor(l.value*.35));Q.value=`${r}px ${v}`}const p=R(()=>n.allPlayers.find(t=>t.uuid===n.currentPlayer?.uuid)||null),d=R(()=>n.allPlayers),m=R(()=>(console.log("gameStore.boardData",n.boardData),n.boardData?{rows:n.boardData.rows,cols:n.boardData.cols}:{rows:0,cols:0})),le=R(()=>{const t=n.boardData?.shrink||0;return{rows:Math.max(1,m.value.rows-t*2),cols:Math.max(1,m.value.cols-t*2),shrink:t}}),pe=R(()=>b.value?n.allPlayers.filter(t=>t.position.row===b.value.row&&t.position.column===b.value.col&&t.uuid!==n.currentPlayer?.uuid):[]),_e=R(()=>!b.value||!n.currentPlayer?!1:n.canMoveToCell(b.value.row,b.value.col)),we=R(()=>{if(!b.value||!n.currentPlayer||pe.value.filter(f=>f.lives>0).length===0)return!1;const{row:u,col:v}=b.value,r=Math.abs(u-p.value.position.row)+Math.abs(v-p.value.position.column);return r<=p.value.range&&r>0&&p.value.tokens>=1});function qe(t){let u=t.clientWidth,v=t.clientHeight;if(!u||!v){const r=t.getBoundingClientRect(),f=getComputedStyle(t),$=parseFloat(f.borderLeftWidth||"0")+parseFloat(f.borderRightWidth||"0"),I=parseFloat(f.borderTopWidth||"0")+parseFloat(f.borderBottomWidth||"0");u=Math.max(0,Math.floor(r.width-$)),v=Math.max(0,Math.floor(r.height-I))}return{width:u,height:v}}function Ae(){const t=h.value,u=k.value;if(!t||!u)return;const{width:v,height:r}=qe(u),f=Math.max(1,Math.floor(v)),$=Math.max(1,Math.floor(r));f===_.value&&$===P.value||(_.value=f,P.value=$,O.value=window.devicePixelRatio||1,t.width=Math.floor(_.value*O.value),t.height=Math.floor(P.value*O.value),i.value=t.getContext("2d"),i.value&&(i.value.setTransform(O.value,0,0,O.value,0,0),i.value.imageSmoothingEnabled=!1,l.value=30,ee(),E(1)))}function He(){i.value&&(m.value.rows<=0||m.value.cols<=0||(i.value.clearRect(0,0,_.value,P.value),i.value.save(),i.value.scale(S.value,S.value),i.value.translate(C.value.x,C.value.y),Qe(),Ne(),b.value&&at(b.value.row,b.value.col),p&&st(),i.value.restore(),et()))}function Ne(){for(const t of d.value){const v=Ua(U.value,t.uuid)||{row:t.position.row,col:t.position.column},r=v.col*l.value,f=v.row*l.value,$=t.taken_tank,I=t.lives>0;if(Ze(i.value,r,f,l.value,t.color,I,$,t.uuid===p.value?.uuid),t.uuid===p.value?.uuid&&(i.value.strokeStyle=N.value.modalHeader,i.value.lineWidth=3,i.value.beginPath(),i.value.arc(r+l.value/2,f+l.value/2,l.value/2,0,Math.PI*2),i.value.stroke()),t.lives>0)if(t.lives>3)i.value.fillStyle="#e74c3c",i.value.font=`${Math.floor(l.value*.3)}px Arial`,i.value.textAlign="left",i.value.textBaseline="top",i.value.fillText(`${t.lives}❤`,r,f+1);else{i.value.fillStyle="#e74c3c";const K=l.value/8;for(let ae=0;ae<t.lives;ae++){const z=r+5+ae*(K+2),Z=f+5;i.value.fillRect(z,Z,K,K)}}}}function Ze(t,u,v,r,f,$,I,K){t.save(),t.imageSmoothingEnabled=!1;const ae=$?Math.min(1,Math.max(.4,(I?.7:.5)+.15)):.1;t.globalAlpha=ae;const z=V.value;if(z&&z.complete&&z.naturalWidth>0&&z.naturalHeight>0){const Z=Math.max(1,r*.08);let se=r-Z*2,ne=se*Oe;ne>r-Z*2&&(ne=r-Z*2,se=ne/Oe);const Pe=u+(r-ne)/2,Me=v+(r-se)/2,G=document.createElement("canvas");G.width=z.naturalWidth,G.height=z.naturalHeight;const Y=G.getContext("2d");Y.imageSmoothingEnabled=!1,Y.clearRect(0,0,G.width,G.height),Y.fillStyle=f,Y.fillRect(0,0,G.width,G.height),Y.globalCompositeOperation="multiply",Y.drawImage(z,0,0),Y.globalCompositeOperation="destination-in",Y.drawImage(z,0,0),Y.globalCompositeOperation="source-over",t.drawImage(G,Pe,Me,ne,se)}else{const Z=r*.8,se=r*.55,ne=u+(r-Z)/2,Pe=v+(r-se)/2,Me=Math.max(2,r*.08);t.fillStyle=f,t.strokeStyle=$?"#222":"#999",t.lineWidth=Math.max(1,r*.06),Je(t,ne,Pe,Z,se,Me),t.fill(),t.stroke();const G=r*.18,Y=u+r/2,ie=v+r/2;t.beginPath(),t.arc(Y,ie,G,0,Math.PI*2),t.fillStyle="#fff8",t.fill(),t.stroke();const ge=Math.max(2,r*.08),Ue=r*.35;t.beginPath(),t.moveTo(Y-ge/2,ie-G),t.lineTo(Y-ge/2,ie-G-Ue),t.lineTo(Y+ge/2,ie-G-Ue),t.lineTo(Y+ge/2,ie-G),t.closePath(),t.fillStyle="#222a",t.fill()}t.restore()}function Je(t,u,v,r,f,$){const I=Math.min($,r/2,f/2);t.beginPath(),t.moveTo(u+I,v),t.lineTo(u+r-I,v),t.quadraticCurveTo(u+r,v,u+r,v+I),t.lineTo(u+r,v+f-I),t.quadraticCurveTo(u+r,v+f,u+r-I,v+f),t.lineTo(u+I,v+f),t.quadraticCurveTo(u,v+f,u,v+f-I),t.lineTo(u,v+I),t.quadraticCurveTo(u,v,u+I,v),t.closePath()}function Qe(){if(!i.value)return;const t=m.value.rows,u=m.value.cols,v=le.value.shrink;i.value.fillStyle=N.value.bg,i.value.save(),i.value.setTransform(1,0,0,1,0,0),i.value.fillRect(0,0,h.value.width,h.value.height),i.value.restore(),i.value.strokeStyle=N.value.grid,i.value.lineWidth=.5;for(let r=0;r<=u;r++){const f=Math.floor(r*l.value);i.value.beginPath(),i.value.moveTo(f,0),i.value.lineTo(f,t*l.value),i.value.stroke()}for(let r=0;r<=t;r++){const f=Math.floor(r*l.value)+.5;i.value.beginPath(),i.value.moveTo(0,f),i.value.lineTo(u*l.value,f),i.value.stroke()}if(v>0){i.value.fillStyle="rgba(240, 60, 80, 0.3)";for(let r=0;r<=t-1;r++)for(let f=0;f<=u-1;f++)(r<v||r>=t-v||f<v||f>=u-v)&&i.value.fillRect(f*l.value,r*l.value,l.value,l.value)}i.value.fillStyle=N.value.text,i.value.font=Q.value,i.value.textAlign="center",i.value.textBaseline="top";for(let r=0;r<u;r++){const f=r*l.value+l.value/2;i.value.fillText(String(r),f,5-Math.min(C.value.y,l.value))}i.value.textAlign="left",i.value.textBaseline="middle";for(let r=0;r<t;r++){const f=r*l.value+l.value/2;i.value.fillText(String(r),5-Math.min(C.value.x,l.value),f)}}function et(){i.value&&(U.value=Ia(U.value),La(i.value,U.value,l.value,S.value,C.value.x,C.value.y))}function tt(){if(W!==null)return;const t=()=>{W=null;const u=x.value||H.value||F.value||he(U.value);u?j=10:j>0&&(j-=1),He(),(u||j>0)&&(W=requestAnimationFrame(t))};W=requestAnimationFrame(t)}function E(t=3){j=Math.max(j,t),tt()}function at(t,u){const v=u*l.value,r=t*l.value;i.value.strokeStyle=N.value.modalHeader,i.value.lineWidth=3,i.value.setLineDash([5,5]),i.value.strokeRect(v,r,l.value,l.value),i.value.setLineDash([])}function st(){if(!p||!i.value)return;const t=p.value.range,u=p.value.position.row,v=p.value.position.column;i.value.fillStyle="rgba(76, 175, 80, 0.15)";for(let r=u-t;r<=u+t;r++)for(let f=v-t;f<=v+t;f++){const $=Math.abs(r-u)+Math.abs(f-v);if($<=t&&$>0&&r>=0&&f>=0&&r<m.value.rows&&f<m.value.cols){const I=f*l.value,K=r*l.value;i.value.fillRect(I,K,l.value,l.value)}}}function nt(t,u){const v=h.value.getBoundingClientRect(),r=(t-v.left)/S.value-C.value.x,f=(u-v.top)/S.value-C.value.y,$=Math.floor(r/l.value);return{row:Math.floor(f/l.value),col:$}}function $e(t,u){const v=(u*l.value+C.value.x)*S.value,r=(t*l.value+C.value.y)*S.value;return{x:v,y:r}}function ot(t){if(x.value||A.value)return;const{row:u,col:v}=nt(t.clientX,t.clientY);if(u<0||v<0||u>=m.value.rows||v>=m.value.cols)return;if(b.value&&b.value.row===u&&b.value.col===v){console.log("Cell clicked again, toggling popup off"),X.value=!X.value,b.value=null,E(1);return}b.value={row:u,col:v},console.log("Cell clicked:",u,v);const r=d.value.find(I=>I.position.row===u&&I.position.column===v);r&&(U.value=Ra(U.value,u,v,l.value,r.color),E(5));const{x:f,y:$}=$e(u,v);L.value={x:Math.min(f+50,_.value-250),y:Math.max($-250,0)},X.value=!0,E(1)}function lt(t){x.value=!0,A.value=!1,T.value={x:t.clientX,y:t.clientY}}function rt(t){if(!x.value)return;const u=t.clientX-T.value.x,v=t.clientY-T.value.y;(Math.abs(u)>ze||Math.abs(v)>ze)&&(A.value=!0),C.value.x+=u/S.value,C.value.y+=v/S.value,T.value={x:t.clientX,y:t.clientY},E(10)}function Te(){x.value=!1,E(5)}function it(t){F.value=!0;const u=t.deltaY>0?.9:1.1,v=Math.max(.5,Math.min(3,S.value*u)),r=h.value.getBoundingClientRect(),f=t.clientX-r.left,$=t.clientY-r.top,I=f/S.value-C.value.x,K=$/S.value-C.value.y;C.value.x=f/v-I,C.value.y=$/v-K,S.value=v,E(10),setTimeout(()=>F.value=!1,0)}function ut(t){if(t.touches.length===1){const u=t.touches.item(0);T.value={x:u.clientX,y:u.clientY},x.value=!0,A.value=!1}else if(t.touches.length===2){H.value=!0;const u=t.touches.item(0),v=t.touches.item(1);B.value=Math.sqrt(Math.pow(v.clientX-u.clientX,2)+Math.pow(v.clientY-u.clientY,2))}}function ct(t){if(t.touches.length===1&&!H.value){const u=t.touches.item(0),v=u.clientX-T.value.x,r=u.clientY-T.value.y;(Math.abs(v)>5||Math.abs(r)>5)&&(C.value.x+=v/S.value,C.value.y+=r/S.value,E(10)),T.value={x:u.clientX,y:u.clientY},E(10)}else if(t.touches.length===2){const u=t.touches.item(0),v=t.touches.item(1),r=Math.sqrt(Math.pow(v.clientX-u.clientX,2)+Math.pow(v.clientY-u.clientY,2)),f=r/B.value,$=Math.max(.5,Math.min(3,S.value*f));S.value=$,B.value=r,H.value=!0,E(10)}}function dt(){x.value=!1,H.value=!1}function vt(){S.value=1,C.value={x:0,y:0},E(5)}function Ie(t){if(!t)return;console.log("Centering on player",t.name,t.position);const u=_.value/2,v=P.value/2;C.value.x=u/S.value-(t.position.column*l.value+l.value/2),C.value.y=v/S.value-(t.position.row*l.value+l.value/2),b.value={row:t.position.row,col:t.position.column};const{x:r,y:f}=$e(t.position.row,t.position.column);L.value={x:Math.min(r+50,_.value-250),y:Math.max(f-250,0)},X.value=!0,E(3)}function xe(t,u,v){U.value=xa(U.value,t,u,l.value,"explosion",v),E(10)}function Re(t,u,v,r,f){const $=(u+.5)*l.value,I=(t+.5)*l.value,K=(r+.5)*l.value,ae=(v+.5)*l.value;U.value=Fa(U.value,$,I,K,ae,.05,f),E(10)}function Fe(t,u,v,r,f){U.value=Ea(U.value,u,v,r,f,t,2),E(10)}function ft(t,u,v,r,f){Re(t,u,v,r,()=>{xe(v,r,f)})}o({triggerExplosion:xe,triggerBullet:Re,triggerBulletAndExplosion:ft,triggerTankMove:Fe,centerOnPlayer:Ie});function ht(t){if(t.action==="move"&&p.value){const u=p.value.position.row,v=p.value.position.column,r=t.targetCell.row,f=t.targetCell.col,$={...t,animationTrigger:{triggerTankMove:()=>{Fe(p.value.uuid,u,v,r,f)}}};c("actionPerformed",$)}else c("actionPerformed",t);Ee()}function Ee(){X.value=!1,b.value=null}let te=null;function Le(){te!==null&&cancelAnimationFrame(te),te=requestAnimationFrame(()=>{te=null,Ae(),E(2)})}return Ce(()=>[d.value,n.boardData,p.value],()=>{bt(()=>E(3))},{deep:!0}),Ce(()=>l.value,()=>{ee(),E(2)}),Se(()=>{Ae(),window.addEventListener("resize",Le);const t=new Image;t.src="/assets/bandvagn no shadow.png",t.decoding="async",t.onload=()=>{V.value=t,E(2)},ee(),E(1)}),We(()=>{te!==null&&(cancelAnimationFrame(te),te=null),window.removeEventListener("resize",Le),W!==null&&(cancelAnimationFrame(W),W=null),j=0,U.value=Ke()}),(t,u)=>(g(),y("div",{class:"canvas-container",ref_key:"containerRef",ref:k},[a("canvas",{ref_key:"canvasRef",ref:h,class:"game-canvas",onClick:ot,onMousedown:lt,onMousemove:rt,onMouseup:Te,onMouseleave:Te,onWheel:ce(it,["prevent"]),onTouchstart:ce(ut,["prevent"]),onTouchmove:ce(ct,["prevent"]),onTouchend:ce(dt,["prevent"])},null,544),X.value&&b.value?(g(),ye(wa,{key:0,cell:b.value,"current-player":p.value,"other-players":pe.value,"can-move":_e.value,"can-shoot":we.value,position:L.value,onAction:ht,onClose:Ee},null,8,["cell","current-player","other-players","can-move","can-shoot","position"])):D("",!0),a("div",Ba,[a("button",{onClick:vt,class:"control-btn",title:"Reset zoom"},"(0,0)"),p.value?(g(),y("button",{key:0,onClick:u[0]||(u[0]=v=>Ie(p.value)),class:"control-btn",title:"Center on player"}," 🎯 ")):D("",!0)]),oe.value?(g(),y("div",Ya,[...u[1]||(u[1]=[a("div",{class:"loading-spinner"},"⏳",-1),a("p",null,"Laddar spel...",-1)])])):D("",!0)],512))}}),Xa=ke(Ga,[["__scopeId","data-v-caff5250"]]),Ka={id:"app-container"},za={class:"stats-container"},Oa={class:"stats-content"},Va={key:0,class:"stats-grid"},Wa={class:"stat-item"},ja={class:"stat-value"},qa={class:"stat-item"},Ha={class:"stat-value"},Na={class:"stat-item"},Za={class:"stat-value"},Ja={class:"stat-item"},Qa={class:"stat-value"},es={key:1,class:"no-player-message"},ts={key:2,class:"players-list"},as={class:"players-list-header"},ss={class:"players-list-items"},ns={class:"player-name"},os={class:"player-position"},ls={class:"player-distance"},rs={class:"player-focus"},is=["onClick"],us={class:"player-meta"},cs={class:"mobile-controls-bar"},ds={class:"mobile-top-row"},vs={key:0,class:"mobile-game-info"},fs={class:"mobile-tokens"},hs={class:"mobile-lives"},ps={class:"mobile-btn-container"},gs=["disabled"],ys={key:0},ms={key:1},bs={class:"game-layout"},ks={class:"sidebar desktop-only"},_s={class:"sidebar-btn-container"},ws=["disabled"],Ps={key:0},Ms={key:1},Cs={key:0},Ss={key:1},Ds={key:0,class:"action-buttons"},As=["disabled"],$s=["disabled"],Ts={class:"canvas-outer-wrapper"},Is={class:"canvas-container"},xs={key:1,class:"upgrade-modal auth-form"},Rs={class:"form-base"},Fs={key:0},Es={key:1},Ls={key:3,class:"loading-container"},Us={key:4,class:"no-player-container"},Bs={key:0,class:"mobile-actions"},Ys=["disabled"],Gs=["disabled"],Xs={class:"sidebar desktop-only"},Ks={key:0,class:"game-info"},zs={class:"info-item"},Os={class:"info-value"},Vs={class:"info-item"},Ws={class:"info-value"},js={class:"info-item"},qs={class:"info-value"},Hs={class:"info-item"},Ns={class:"info-value"},Zs={class:"info-item"},Js={key:1,class:"game-logs"},Qs={class:"logs-container"},en={class:"log-header"},tn={class:"log-timestamp"},an={class:"log-content"},sn={class:"log-action"},nn={key:0,class:"mobile-stats"},on={class:"mobile-stats-grid"},ln={class:"mobile-stat-item"},rn={class:"mobile-stat-value"},un={class:"mobile-stat-item"},cn={key:1,class:"information-container"},dn={__name:"Kfkbandvagn",setup(e){const o=M(null),s=re(),n=De(),c=M(!1),k=M(!1),h=M(!1),i=M(!1),_=M(""),P=M(!1),l=R(()=>n.currentPlayer),S=R(()=>n.allPlayers),C=R(()=>n.boardData),x=R(()=>n.isLoading);function F(){return console.log("Checking game initialized:",n.initialized,l.value),n.initialized&&l.value}const A=R(()=>S.value.filter(d=>d.taken_tank).map(d=>({...d,distToCurrent:l.value?Math.abs(d.position.row-l.value.position.row)+Math.abs(d.position.column-l.value.position.column):1/0})).sort((d,m)=>d.distToCurrent-m.distToCurrent)),T=R(()=>C.value?.logs?C.value.logs.slice().reverse():[]);function oe(){c.value=!c.value}function O(){k.value=!k.value}async function V(){try{await n.fetchGameState()}catch(p){console.error("Failed to refresh game state:",p)}}function X(){h.value=!0}function L(){h.value=!1}function b(){h.value=!1,V()}function B(p){o.value.centerOnPlayer(p)}async function H(p){try{p.action==="shot"&&o.value&&(p.animationTrigger={triggerBulletAndExplosion:o.value.triggerBulletAndExplosion}),await n.performAction(p)}catch(d){console.error("Action failed:",d)}}function U(p){_.value=p,i.value=!0}function W(){i.value=!1,_.value=""}async function j(){console.log("Confirming upgrade:",_.value);try{await n.performAction({action:_.value,tank_id:l.value?.uuid||""}),i.value=!1,_.value="",console.log("Upgrade successful")}catch(p){console.error("Upgrade failed:",p)}}function N(p){const d=new Date(p),m=d.getFullYear().toString().slice(-2),le=String(d.getMonth()+1).padStart(2,"0"),pe=String(d.getDate()).padStart(2,"0"),_e=String(d.getHours()).padStart(2,"0"),we=String(d.getMinutes()).padStart(2,"0");return`${m}-${le}-${pe} ${_e}:${we}`}function Q(p){const d=l.value&&p.playerID===l.value.playerID;let m="";switch(p.action){case"shot":p.details?.targetUser?m=`Sköt ${p.details.targetUser} (${p.details.targetUserLives} liv kvar)`:m="Sköt";break;case"move":p.details?.position?m=`Flyttade till (${p.details.position.row}, ${p.details.position.column})`:m="Flyttade";break;case"range":p.details?.range?m=`Köpte räckvidd (${p.details.range-1} → ${p.details.range})`:m="Köpte räckvidd";break;case"life":p.details?.lives?m=`Köpte liv (${p.details.lives-1} → ${p.details.lives})`:m="Köpte liv";break;case"board_shrink":m="Spelplanen krympte";break;case"token_distribution":p.details?.tokensGiven?m=`Alla fick ${p.details.tokensGiven} tokens`:m="Alla fick tokens";break;case"death":p.details?.targetUser?m=`${p.details.targetUser} dog`:m="Någon dog";break;case"respawn":m="Återuppstod";break;default:m=p.action;break}return{timestamp:N(p.timestamp),playerID:p.playerID,actionDescription:m,isCurrentPlayer:d}}function ee(){P.value=window.innerWidth<=768}return Ce(()=>s.authStateVersion,async(p,d)=>{if(console.log(`Auth state version changed: ${d} -> ${p}`),s.isAuthed){console.log("User authenticated, initializing game store");try{await n.initialize(),l.value?h.value=!1:h.value=!0}catch(m){console.error("Failed to initialize game store after auth change:",m)}}else console.log("User logged out, resetting game store"),n.reset(),h.value=!1},{immediate:!1}),Se(async()=>{if(ee(),window.addEventListener("resize",ee),s.isAuthed){console.log("User authenticated, initializing game store");try{await n.initialize()}catch(p){console.error("Failed to initialize game store on mount:",p)}}}),We(()=>{window.removeEventListener("resize",ee)}),(p,d)=>(g(),y("div",Ka,[d[30]||(d[30]=a("h1",{class:"game-header"},"KfKbandvagn",-1)),a("div",za,[a("button",{onClick:O,class:"stats-toggle"},[d[4]||(d[4]=a("span",null,"Spelstatus",-1)),a("span",{class:q(["toggle-icon",{expanded:k.value}])},"▼",2)]),a("div",{class:q(["stats-wrapper",{expanded:k.value}])},[a("div",Oa,[l.value?(g(),y("div",Va,[a("div",Wa,[d[5]||(d[5]=a("span",{class:"stat-label"},"Spelare",-1)),a("span",ja,w(l.value.playerID),1)]),a("div",qa,[d[6]||(d[6]=a("span",{class:"stat-label"},"Tokens",-1)),a("span",Ha,w(l.value.tokens),1)]),a("div",Na,[d[7]||(d[7]=a("span",{class:"stat-label"},"Liv",-1)),a("span",Za,w(l.value.lives),1)]),a("div",Ja,[d[8]||(d[8]=a("span",{class:"stat-label"},"Räckvidd",-1)),a("span",Qa,w(l.value.range),1)])])):(g(),y("div",es,[...d[9]||(d[9]=[a("p",null,"Ingen aktiv spelare - logga in eller skapa en bandvagn",-1)])])),A.value.length?(g(),y("div",ts,[a("div",as,[a("span",null,"Spelare på brädet ("+w(A.value.length)+")",1)]),a("ul",ss,[d[10]||(d[10]=Ge('<li style="border-bottom:1px solid var(--theme-border-light);" data-v-b07239ab><span class="players-list-header" data-v-b07239ab>Namn</span><span class="players-list-header" data-v-b07239ab>Position (r,c)</span><span class="players-list-header" data-v-b07239ab>Distans</span><span class="players-list-header" data-v-b07239ab>Visa</span><span data-v-b07239ab></span></li>',1)),(g(!0),y(me,null,be(A.value,m=>(g(),y("li",{key:m.uuid,class:"players-list-item"},[a("div",null,[m.uuid===l.value?.uuid?(g(),y("span",{key:0,class:"current-player-indicator",style:ve({color:m.color,background:"#ffd70099",borderRadius:"5px"})},"★",4)):D("",!0),m.uuid!==l.value?.uuid?(g(),y("span",{key:1,class:"player-dot",style:ve({backgroundColor:m.color})},null,4)):D("",!0),a("span",ns,w(m.playerID),1)]),a("span",os,w(m.position.row)+", "+w(m.position.column),1),a("span",ls,w(m.distToCurrent),1),a("span",rs,[a("button",{onClick:le=>B(m)},"🔍",8,is)]),a("span",us,"❤ "+w(m.lives)+" · ➶ "+w(m.range)+" · ⛁ "+w(m.tokens),1)]))),128))])])):D("",!0)])],2)]),a("div",cs,[a("div",ds,[l.value?(g(),y("div",vs,[a("span",fs,w(l.value.tokens)+" tokens",1),a("span",hs,w(l.value.lives)+" liv",1)])):D("",!0),a("div",ps,[a("button",{onClick:V,class:"mobile-btn",disabled:x.value},[x.value?(g(),y("span",ys,"⏳")):(g(),y("span",ms,"🔄"))],8,gs),a("button",{onClick:oe,class:"mobile-btn"},"ℹ️")])])]),a("div",bs,[a("div",ks,[a("div",_s,[a("button",{onClick:V,class:"sidebar-btn",disabled:x.value},[x.value?(g(),y("span",Ps,"Laddar...")):(g(),y("span",Ms,"Uppdatera"))],8,ws),a("button",{onClick:oe,class:"sidebar-btn"},[c.value?(g(),y("span",Cs,"Dölj Info")):(g(),y("span",Ss,"Visa Info"))])]),l.value&&l.value.lives>0?(g(),y("div",Ds,[a("button",{onClick:d[0]||(d[0]=m=>U("range")),class:"action-btn",disabled:l.value.tokens<3},[...d[11]||(d[11]=[J(" Köp Räckvidd ",-1),a("br",null,null,-1),J(" (3 tokens) ",-1)])],8,As),a("button",{onClick:d[1]||(d[1]=m=>U("life")),class:"action-btn",disabled:l.value.tokens<3},[...d[12]||(d[12]=[J(" Köp Liv ",-1),a("br",null,null,-1),J(" (3 tokens) ",-1)])],8,$s)])):D("",!0)]),a("div",Ts,[a("div",Is,[h.value?(g(),ye(qt,{key:0,onClose:L,onPlayerCreated:b})):D("",!0),i.value?(g(),y("div",xs,[a("div",Rs,[d[17]||(d[17]=a("h3",null,"Bekräfta Köp",-1)),_.value==="range"?(g(),y("p",Fs,[d[13]||(d[13]=J(" Vill du köpa ökad räckvidd för 3 tokens?",-1)),d[14]||(d[14]=a("br",null,null,-1)),J(" Din nuvarande räckvidd: "+w(l.value?.range||0),1)])):D("",!0),_.value==="life"?(g(),y("p",Es,[d[15]||(d[15]=J(" Vill du köpa ett extra liv för 3 tokens?",-1)),d[16]||(d[16]=a("br",null,null,-1)),J(" Dina nuvarande liv: "+w(l.value?.lives||0),1)])):D("",!0),a("div",{class:"button-group"},[a("button",{onClick:W,class:"button-base decline"},"Avbryt"),a("button",{onClick:j,class:"button-base"},"Köp")])])])):D("",!0),F()?(g(),ye(Xa,{key:2,ref_key:"canvasRef",ref:o,onActionPerformed:H},null,512)):x.value?(g(),y("div",Ls,[...d[18]||(d[18]=[a("div",{class:"loading-spinner"},"⏳",-1),a("p",null,"Laddar spel...",-1)])])):(g(),y("div",Us,[d[19]||(d[19]=a("h2",null,"Välkommen till KfKbandvagn!",-1)),d[20]||(d[20]=a("p",null,"Du behöver logga in och skapa en bandvagn för att spela.",-1)),a("button",{onClick:X,class:"button-base"},"Skapa Bandvagn")]))]),l.value&&l.value.lives>0?(g(),y("div",Bs,[a("button",{onClick:d[2]||(d[2]=m=>U("range")),class:"mobile-action-btn",disabled:l.value.tokens<3}," Räckvidd (3t) ",8,Ys),a("button",{onClick:d[3]||(d[3]=m=>U("life")),class:"mobile-action-btn",disabled:l.value.tokens<3}," Liv (3t) ",8,Gs)])):D("",!0)]),a("div",Xs,[l.value?(g(),y("div",Ks,[a("div",zs,[d[21]||(d[21]=a("span",{class:"info-label"},"Position",-1)),a("span",Os,w(l.value.position.row)+", "+w(l.value.position.column),1)]),a("div",Vs,[d[22]||(d[22]=a("span",{class:"info-label"},"Tokens",-1)),a("span",Ws,w(l.value.tokens),1)]),a("div",js,[d[23]||(d[23]=a("span",{class:"info-label"},"Liv",-1)),a("span",qs,w(l.value.lives),1)]),a("div",Hs,[d[24]||(d[24]=a("span",{class:"info-label"},"Räckvidd",-1)),a("span",Ns,w(l.value.range),1)]),a("div",Zs,[d[25]||(d[25]=a("span",{class:"info-label"},"Status",-1)),a("span",{class:q(["info-value",{dead:l.value.lives<=0}])},w(l.value.lives>0?"Levande":"Död"),3)])])):D("",!0),C.value&&C.value.logs?(g(),y("div",Js,[d[26]||(d[26]=a("h4",null,"Senaste Händelser",-1)),a("div",Qs,[(g(!0),y(me,null,be(T.value,(m,le)=>(g(),y("div",{key:le,class:"log-entry"},[a("div",en,[a("span",tn,w(Q(m).timestamp),1),a("span",{class:q(["log-player",{"current-player":Q(m).isCurrentPlayer}])},w(Q(m).playerID),3)]),a("div",an,[a("span",sn,w(Q(m).actionDescription),1)])]))),128))])])):D("",!0)])]),l.value?(g(),y("div",nn,[a("div",on,[a("div",ln,[d[27]||(d[27]=a("span",{class:"mobile-stat-label"},"Position",-1)),a("span",rn,w(l.value.position.row)+","+w(l.value.position.column),1)]),a("div",un,[d[28]||(d[28]=a("span",{class:"mobile-stat-label"},"Status",-1)),a("span",{class:q(["mobile-stat-value",{dead:l.value.lives<=0}])},w(l.value.lives>0?"Levande":"Död"),3)])])])):D("",!0),c.value?(g(),y("div",cn,[...d[29]||(d[29]=[Ge('<div class="information-text" data-v-b07239ab><div class="background-decor" data-v-b07239ab><div class="information-inset" data-v-b07239ab><strong data-v-b07239ab>Spelregler</strong><p data-v-b07239ab> Varje spelare börjar på en slumpmässig plats på spelplanen med 3 hjärtan (liv), 2 rutor i räckvidd och 0 Tokens. Tokens förelas automatiskt dagligen. Använd tokens för att utföra handlingar. </p></div></div><div class="background-decor" data-v-b07239ab><div class="information-inset" data-v-b07239ab><strong data-v-b07239ab>Handlingar</strong><p data-v-b07239ab><strong data-v-b07239ab>Flytta:</strong> Klicka på en tom ruta för att flytta dit (1 token per ruta).<br data-v-b07239ab><strong data-v-b07239ab>Skjut:</strong> Klicka på en annan spelare inom din räckvidd för att skjuta (1 token). Om spelaren dör får du 5 tokens.<br data-v-b07239ab><strong data-v-b07239ab>Köp Räckvidd:</strong> Öka din räckvidd med 1 (3 tokens).<br data-v-b07239ab><strong data-v-b07239ab>Köp Liv:</strong> Få ett extra liv (3 tokens). </p></div></div><div class="background-decor" data-v-b07239ab><div class="information-inset" data-v-b07239ab><strong data-v-b07239ab>Liv och Dödsfall</strong><p data-v-b07239ab> Om du blir skjuten förlorar du ett liv. När du når 0 liv är du ute ur spelet (kom ihåg att köpa liv). Du kan återuppstå genom att en annan spelare donerar ett liv till dig. </p></div></div><div class="background-decor" data-v-b07239ab><div class="information-inset" data-v-b07239ab><strong data-v-b07239ab>Spelplan</strong><p data-v-b07239ab> Spelplanen krymper regelbundet och spelare utanför den aktiva ytan förlorar ett liv för varje gång spelplanen krymper. Nya tokens fördelas automatiskt till alla levande spelare. Planera dina drag väl! </p></div></div></div>',1)])])):D("",!0)]))}},fn=ke(dn,[["__scopeId","data-v-b07239ab"]]);export{fn as default};
