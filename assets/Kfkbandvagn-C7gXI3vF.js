import{A as We,G as pt,H as gt,B as re,_ as be,r as w,j as F,o as Se,c as y,h,C as ye,d as A,D as yt,b as t,z as le,t as k,e as ue,f as Ge,v as Ye,F as ce,p as me,x as ve,y as j,I as mt,w as Ce,k as je,n as bt,E as Xe,s as W}from"./index-CIJZ9MWw.js";class de extends Error{code;status;constructor(o,s,n){super(o),this.name="BandvagnAPIError",this.code=s,this.status=n}}async function fe(e,o="GET",s){console.log("Making request to endpoint:",e,"with method:",o,"and body:",s);try{const n={method:o};s&&(n.body=s);const{data:c,error:b}=await We.functions.invoke(`kfkbandvagn${e}`,n);if(console.log("Response data:",c,"Error:",b),b)throw console.error("Edge Function error:",b),new de(b.message||"Request failed",b.name,b.status);if(c&&typeof c=="object"){if("success"in c&&c.success===!1){const p=c;throw new de(p.error?.message||p.message||"Request failed",p.error?.code)}return"data"in c?c.data:c}return c}catch(n){throw n instanceof de?n:(console.error("API request failed:",n),new de(n instanceof Error?n.message:"Unknown API error"))}}function ze(e){return e instanceof de?{no_player_found:"Ingen spelare hittades",no_free_tanks:"Inga lediga tanks",player_already_exists:"Du har redan en bandvagn",missing_tokens:"Inte nog med tokens",invalid_action:"Ogiltigt drag",not_in_range:"Inte inom räckvidd",player_already_dead:"Spelaren är redan död",invalid_session:"Session har gått ut, logga in igen",validation_error:"Ogiltiga data",internal_error:"Serverfel, försök igen"}[e.code||""]||e.message||"Ett fel uppstod":e instanceof Error?e.message:"Ett oväntat fel uppstod"}async function qe(){return fe("/game/state","GET",void 0)}async function kt(){return fe("/game/stats","GET",void 0)}const _t=Object.freeze(Object.defineProperty({__proto__:null,getGameState:qe,getGameStats:kt},Symbol.toStringTag,{value:"Module"}));async function wt(e){return fe("/auth/create","POST",e)}async function Pt(e){return fe("/auth/login","POST",e)}async function Mt(e){return console.log("performGameAction called with action:",e),fe("/game/action","POST",e)}const De=pt("bandvagn",{state:()=>({allPlayers:[],currentPlayer:null,boardData:null,initialized:!1,isLoading:!1,error:null,lastFetch:null,selectedCell:null,autoRefreshEnabled:!0,refreshInterval:36e5,refreshTimeoutId:null}),getters:{isPlayerAlive:e=>(e.currentPlayer?.lives||0)>0,canAffordUpgrade:e=>o=>(e.currentPlayer?.tokens||0)>=o,boardSize:e=>e.boardData?{rows:e.boardData.rows,cols:e.boardData.cols}:{rows:0,cols:0},playableBoardSize:e=>{if(!e.boardData)return{rows:0,cols:0};const o=e.boardData.shrink||0;return{rows:Math.max(1,e.boardData.rows-o*2),cols:Math.max(1,e.boardData.cols-o*2)}},recentLogs:e=>e.boardData?.logs?.slice(-20)||[],otherPlayers:e=>e.allPlayers.filter(o=>o.uuid!==e.currentPlayer?.uuid&&o.taken_tank),isDataFresh:e=>e.lastFetch?new Date().getTime()-e.lastFetch.getTime()<3e4:!1,gameStats:e=>{const o=e.allPlayers.filter(n=>n.lives>0&&n.taken_tank).length,s=e.allPlayers.filter(n=>n.taken_tank).length;return{alivePlayers:o,totalPlayers:s,boardShrink:e.boardData?.shrink||0}}},actions:{async initialize(){if(console.log("Initializing bandvagn store"),this.initialized){console.log("Bandvagn store already initialized, skipping");return}if(!re().isAuthed){console.warn("Cannot initialize bandvagn store - user not authenticated");return}this.isLoading=!0,this.error=null;try{await this.fetchGameState(),this.initialized=!0,this.autoRefreshEnabled&&this.startAutoRefresh(),console.log("Bandvagn store initialized successfully")}catch(o){console.error("Failed to initialize bandvagn store:",o),this.error=o instanceof Error?o.message:"Initialization failed"}finally{this.isLoading=!1}},async fetchGameState(){this.isLoading=!0,this.error=null;try{console.log("Fetching game state from server...");const e=await qe();this.allPlayers=e.playerData||[],e.boardData&&(this.boardData={rows:e.boardData.size.rows,cols:e.boardData.size.columns,shrink:e.boardData.shrink,logs:e.boardData.logs,upgrades:e.boardData.upgrades||[],time_to_shrink:e.boardData.time_to_shrink||""}),await this.fetchCurrentUserTank(),this.lastFetch=new Date,console.log("Game state updated:",{players:this.allPlayers.length,currentPlayer:!!this.currentPlayer,boardSize:this.boardSize})}catch(e){throw console.error("Failed to fetch game state:",e),this.error=e instanceof Error?e.message:"Failed to fetch game state",e}finally{this.isLoading=!1}},async fetchCurrentUserTank(){const e=re();if(!e.user?.id)return this.currentPlayer=null,null;try{const{data:o,error:s}=await We.from("KfKbandvagn").select("user_id, playerID, uuid, tokens, position, lives, range, color, taken_tank").eq("user_id",e.user.id).maybeSingle();return s?(console.error("Failed to fetch current user's tank:",s),this.currentPlayer=null,null):!o||o.taken_tank===!1?(this.currentPlayer=null,null):(this.currentPlayer={uuid:o.uuid,playerID:o.playerID,position:o.position,lives:o.lives,tokens:o.tokens,range:o.range,taken_tank:o.taken_tank,color:o.color},this.currentPlayer)}catch(o){return console.error("Unexpected error fetching current user's tank:",o),this.currentPlayer=null,null}},async createPlayer(e){const o=re();if(!o.user?.id)throw new Error("User not authenticated");this.isLoading=!0,this.error=null;try{const s=await wt({user_id:o.user.id,playerID:e.playerID,color:e.color});return await this.fetchGameState(),s}catch(s){throw console.error("Failed to create player:",s),this.error=s instanceof Error?s.message:"Failed to create player",s}finally{this.isLoading=!1}},async loginPlayer(){const e=re();if(!e.user?.id)throw new Error("User not authenticated");this.isLoading=!0,this.error=null;try{const o=await Pt({user_id:e.user.id});return await this.fetchGameState(),o}catch(o){throw console.error("Failed to login player:",o),this.error=o instanceof Error?o.message:"Failed to login player",o}finally{this.isLoading=!1}},async performAction(e){this.isLoading=!0,this.error=null;try{const o={action:e.action,tank_id:e.tank_id};e.action==="move"&&e.targetCell&&(o.moveDirection={row:e.targetCell.row,col:e.targetCell.col}),e.action==="shot"&&e.targetUUID&&(o.targetUUID=e.targetUUID),console.log("Performing action:",o);const s=await Mt(o);if(console.log("Action result:",s),e.action==="shot"&&e.animationTrigger?.triggerBulletAndExplosion&&e.targetUUID&&this.currentPlayer){const n=this.allPlayers.find(c=>c.uuid===e.targetUUID);if(n){const c=this.currentPlayer.position,b=n.position;this.currentPlayer=s.updatedData;const p=this.allPlayers.findIndex(i=>i.uuid===s.updatedData.uuid);return p!==-1&&(this.allPlayers[p]=s.updatedData),e.animationTrigger.triggerBulletAndExplosion(c.row,c.column,b.row,b.column,()=>{if(s.shotData){const i=this.allPlayers.findIndex(_=>_.uuid===e.targetUUID);i!==-1&&(this.allPlayers[i]=s.shotData)}s.updatedLogs&&this.boardData&&(Array.isArray(s.updatedLogs)?this.boardData.logs=s.updatedLogs:this.boardData.logs=[...this.boardData.logs,s.updatedLogs])}),s}}if(e.action==="move"&&this.currentPlayer){if(s.updatedData){const n=this.allPlayers.findIndex(c=>c.uuid===s.updatedData.uuid);n!==-1&&(this.allPlayers[n]=s.updatedData),this.currentPlayer=s.updatedData}return s.updatedLogs&&this.boardData&&(Array.isArray(s.updatedLogs)?this.boardData.logs=s.updatedLogs:this.boardData.logs=[...this.boardData.logs,s.updatedLogs]),e.animationTrigger?.triggerTankMove&&e.animationTrigger.triggerTankMove(),s}if(e.action!=="shot"&&s.updatedData){const n=this.allPlayers.findIndex(c=>c.uuid===s.updatedData?.uuid);n!==-1&&(this.allPlayers[n]=s.updatedData),this.currentPlayer=s.updatedData,s.updatedLogs&&this.boardData&&(Array.isArray(s.updatedLogs)?this.boardData.logs=s.updatedLogs:this.boardData.logs=[...this.boardData.logs,s.updatedLogs])}return console.log("Game state refreshed successfully."),s}catch(o){throw console.error("Action failed:",o),this.error=o instanceof Error?o.message:"Action failed",o}finally{this.isLoading=!1}},async fetchGameStats(){try{const{getGameStats:e}=await gt(async()=>{const{getGameStats:s}=await Promise.resolve().then(()=>_t);return{getGameStats:s}},void 0);return await e()}catch(e){throw console.error("Failed to fetch game stats:",e),e}},startAutoRefresh(){this.refreshTimeoutId&&clearTimeout(this.refreshTimeoutId),this.refreshTimeoutId=window.setTimeout(async()=>{if(this.autoRefreshEnabled&&this.initialized){try{await this.fetchGameState()}catch(e){console.error("Auto-refresh failed:",e)}this.startAutoRefresh()}},this.refreshInterval)},stopAutoRefresh(){this.refreshTimeoutId&&(clearTimeout(this.refreshTimeoutId),this.refreshTimeoutId=null)},async forceRefresh(){this.lastFetch=null,await this.fetchGameState()},selectCell(e){this.selectedCell=e},canMoveToCell(e,o){if(!this.currentPlayer||(this.playableBoardSize,this.boardData?.shrink,e<0||e>=this.boardSize.rows||o<0||o>=this.boardSize.cols)||this.allPlayers.some(b=>b.position.row===e&&b.position.column===o&&b.lives>0&&b.uuid!==this.currentPlayer?.uuid)||this.currentPlayer.position.row===e&&this.currentPlayer.position.column===o)return!1;const n=Math.abs(e-this.currentPlayer.position.row)+Math.abs(o-this.currentPlayer.position.column),c=Math.max(1,n);return this.currentPlayer.tokens>=c},canShootAtCell(e,o){if(!this.currentPlayer||!this.allPlayers.find(c=>c.position.row===e&&c.position.column===o&&c.uuid!==this.currentPlayer?.uuid&&c.taken_tank&&c.lives>0))return!1;const n=Math.abs(e-this.currentPlayer.position.row)+Math.abs(o-this.currentPlayer.position.column);return n<=this.currentPlayer.range&&n>0},clearError(){this.error=null},setAutoRefresh(e){this.autoRefreshEnabled=e,e&&this.initialized?this.startAutoRefresh():this.stopAutoRefresh()},reset(){this.stopAutoRefresh(),this.allPlayers=[],this.currentPlayer=null,this.boardData=null,this.initialized=!1,this.isLoading=!1,this.error=null,this.lastFetch=null,this.selectedCell=null}}}),Ct={class:"player-creation-container"},St={key:1,class:"modal-overlay"},Dt={class:"modal-content"},At={class:"player-creation-form"},$t={key:0,class:"user-greeting"},Tt={key:1,class:"auth-prompt"},xt={class:"button-group auth-buttons"},It={class:"form-group"},Rt=["disabled"],Ft={class:"form-group"},Et={class:"color-picker-container"},Lt=["disabled"],Bt={class:"color-value"},Ut=["disabled"],Gt={class:"preset-colors"},Yt={class:"color-presets"},Xt=["onClick","disabled"],zt={key:0,class:"error-message"},Kt={key:1,class:"loading-state"},Ot={key:2,class:"button-group"},Vt={key:3,class:"existing-player-option"},Wt=["disabled"],jt={__name:"PlayerCreation",emits:["close","playerCreated"],setup(e,{emit:o}){const s=re(),n=De(),c=w(""),b=w("#4CAF50"),p=w(!1),i=w(""),_=w(!1),P=w(!0),l=w(""),S=w(!0),D=["#4CAF50","#2196F3","#FF5722","#FF9800","#9C27B0","#607D8B","#795548","#E91E63","#00BCD4","#8BC34A","#FFC107","#3F51B5"],I=o;function E(M){l.value=M,_.value=!0}function $(){_.value=!1,l.value=""}async function T(){_.value=!1,P.value=!1,l.value="";try{await n.fetchGameState()}catch(M){console.warn("Failed to fetch game state after auth",M)}n.currentPlayer?I("playerCreated"):s.profile?.username&&(c.value=s.profile.username)}const ne=F(()=>c.value.length>=2&&c.value.length<=20&&/^[a-zA-Z0-9åäöÅÄÖ\s\-_.]*$/.test(c.value)&&/^#[0-9A-Fa-f]{6}$/.test(b.value));async function z(){if(!ne.value){i.value="Kontrollera att alla fält är korrekt ifyllda";return}if(!s.isAuthed){i.value="Du måste vara inloggad för att skapa en spelare";return}p.value=!0,i.value="";try{await n.createPlayer({playerID:c.value.trim(),color:b.value}),console.log("Player created successfully"),I("playerCreated")}catch(M){console.error("Failed to create player:",M),i.value=ze(M)}finally{p.value=!1}}async function q(){if(!s.isAuthed){i.value="Du måste vara inloggad";return}p.value=!0,i.value="";try{await n.loginPlayer(),console.log("Player logged in successfully"),I("playerCreated")}catch(M){console.error("Failed to login existing player:",M),i.value=ze(M),M.code==="no_player_found"&&(S.value=!1)}finally{p.value=!1}}function X(){I("close")}function H(){const M=`#${Math.floor(Math.random()*16777215).toString(16).padStart(6,"0")}`;b.value=M}return Se(()=>{if(H(),s.isAuthed&&s.profile?.username)c.value=s.profile.username;else if(s.user?.email){const M=s.user.email.split("@")[0];c.value=M.substring(0,15)}s.isAuthed&&setTimeout(async()=>{try{await n.fetchGameState(),n.currentPlayer&&I("playerCreated")}catch{}},0)}),(M,C)=>(h(),y("div",Ct,[_.value?(h(),ye(yt,{key:0,mode:l.value,onClose:$,onSuccess:T,class:"auth-form"},null,8,["mode"])):!_.value&&P.value?(h(),y("div",St,[t("div",Dt,[t("div",At,[t("button",{type:"button",class:"close-form-button",onClick:X},"×"),C[15]||(C[15]=t("h2",null,"Skapa din Bandvagn",-1)),le(s).isAuthed?(h(),y("div",$t,[t("p",null,"Hej "+k(le(s).profile?.username||le(s).user?.email)+"!",1),C[4]||(C[4]=t("p",null,"Skapa din bandvagn för att börja spela.",-1))])):(h(),y("div",Tt,[C[5]||(C[5]=t("p",null,"Du behöver vara inloggad för att spela KfKbandvagn.",-1)),t("div",xt,[t("button",{onClick:C[0]||(C[0]=U=>E("login")),class:"button-base"},"Logga In"),t("button",{onClick:C[1]||(C[1]=U=>E("signup")),class:"button-base"},"Skapa Konto")])])),le(s).isAuthed?(h(),y("form",{key:2,onSubmit:ue(z,["prevent"]),class:"creation-form"},[t("div",It,[C[6]||(C[6]=t("label",{for:"playerID",class:"form-label"},"Spelarnamn",-1)),Ge(t("input",{"onUpdate:modelValue":C[2]||(C[2]=U=>c.value=U),type:"text",id:"playerID",class:"form-input",placeholder:"Ange ditt spelarnamn",disabled:p.value,required:"",minlength:"2",maxlength:"20"},null,8,Rt),[[Ye,c.value]]),C[7]||(C[7]=t("small",{class:"input-help"},"2-20 tecken, inga specialtecken",-1))]),t("div",Ft,[C[8]||(C[8]=t("label",{for:"playerColor",class:"form-label"},"Bandvagnsfärg",-1)),t("div",Et,[Ge(t("input",{"onUpdate:modelValue":C[3]||(C[3]=U=>b.value=U),type:"color",id:"playerColor",class:"color-input",disabled:p.value},null,8,Lt),[[Ye,b.value]]),t("span",Bt,k(b.value),1),t("button",{type:"button",class:"random-color-btn",onClick:H,disabled:p.value,title:"Slumpa färg"}," 🎲 ",8,Ut)]),C[9]||(C[9]=t("small",{class:"input-help"},"Välj en färg för din bandvagn eller slumpa en",-1))]),t("div",Gt,[C[10]||(C[10]=t("label",{class:"form-label"},"Förvalda färger:",-1)),t("div",Yt,[(h(),y(ce,null,me(D,U=>t("button",{key:U,type:"button",class:j(["preset-color-btn",{active:b.value===U}]),style:ve({backgroundColor:U}),onClick:L=>b.value=U,disabled:p.value},null,14,Xt)),64))])]),i.value?(h(),y("div",zt,k(i.value),1)):A("",!0),p.value?(h(),y("div",Kt,[...C[11]||(C[11]=[t("div",{class:"loading-spinner"},"⏳",-1),t("p",null,"Skapar din bandvagn...",-1)])])):A("",!0),p.value?A("",!0):(h(),y("div",Ot,[t("button",{type:"button",onClick:X,class:"button-base decline"},"Avbryt"),C[12]||(C[12]=t("button",{type:"submit",class:"button-base"},"Skapa Bandvagn",-1))]))],32)):A("",!0),le(s).isAuthed&&S.value?(h(),y("div",Vt,[C[13]||(C[13]=t("hr",{class:"divider"},null,-1)),C[14]||(C[14]=t("p",null,"Eller om du redan har en bandvagn:",-1)),t("button",{onClick:q,class:"button-base",disabled:p.value}," Logga in befintlig spelare ",8,Wt)])):A("",!0)])])])):A("",!0)]))}},qt=be(jt,[["__scopeId","data-v-4e7d8c25"]]),Ht={class:"popup-header"},Nt={key:0,class:"players-section"},Zt={class:"player-list"},Jt={class:"player-info"},Qt={class:"player-name"},ea={class:"player-stats"},ta={class:"action-buttons"},aa={key:0,class:"action-option"},sa=["disabled"],na={class:"btn-cost"},oa={key:1,class:"action-option"},la={key:0},ra=["disabled"],ia={class:"btn-text"},ua={key:2,class:"no-actions"},da={key:0},ca={key:1},va={key:2},fa={key:3},ha={key:4},pa={key:5},ga={class:"info-section"},ya={class:"distance-info"},ma={key:0},ba={class:"cell-type-info"},ka={key:0,class:"status-danger"},_a={__name:"GamePopup",props:{cell:{type:Object,required:!0,validator:e=>e&&typeof e.row=="number"&&typeof e.col=="number"},currentPlayer:{type:Object,default:null},otherPlayers:{type:Array,default:()=>[]},canMove:{type:Boolean,default:!1},canShoot:{type:Boolean,default:!1},position:{type:Object,default:()=>({x:0,y:0})}},emits:["action","close"],setup(e,{emit:o}){const s=e,n=o,c=w(!1),b=F(()=>({left:`${s.position.x}px`,top:`${s.position.y}px`})),p=F(()=>s.otherPlayers.filter(E=>E.lives>0)),i=F(()=>!s.currentPlayer||!s.cell?0:Math.abs(s.cell.row-s.currentPlayer.position.row)+Math.abs(s.cell.col-s.currentPlayer.position.column)),_=F(()=>Math.max(1,i.value)),P=F(()=>s.currentPlayer?s.currentPlayer.tokens>=_.value:!1),l=F(()=>s.currentPlayer?s.currentPlayer.tokens>=1:!1),S=F(()=>!0),D=F(()=>s.otherPlayers.some(E=>E.taken_tank));async function I(E,$=null){if(c.value){console.log("Action already in progress, ignoring click");return}c.value=!0;try{const T={action:E,tank_id:s.currentPlayer?.uuid||""};E==="move"&&(T.targetCell={row:s.cell.row,col:s.cell.col}),$&&(T.targetUUID=$),await n("action",T)}catch(T){console.error("Error performing action:",T)}finally{setTimeout(()=>{c.value=!1},1e3)}}return(E,$)=>e.cell?(h(),y("div",{key:0,class:"game-popup",style:ve(b.value)},[t("button",{class:"popup-close",onClick:$[0]||($[0]=T=>E.$emit("close"))},"×"),t("div",Ht,[t("h4",null,"Cell ("+k(e.cell.row)+", "+k(e.cell.col)+")",1)]),e.otherPlayers.length>0?(h(),y("div",Nt,[t("div",Zt,[(h(!0),y(ce,null,me(e.otherPlayers,T=>(h(),y("div",{key:T.uuid,class:j(["player-item",{dead:T.lives<=0}])},[t("div",{class:"player-color",style:ve({backgroundColor:T.color})},null,4),t("div",Jt,[t("span",Qt,k(T.playerID),1),t("span",ea,k(T.lives)+" liv, "+k(T.tokens)+" tokens",1)])],2))),128))])])):A("",!0),t("div",ta,[e.canMove?(h(),y("div",aa,[t("button",{onClick:$[1]||($[1]=T=>I("move")),class:j(["action-btn move-btn",{disabled:!P.value||c.value}]),disabled:!P.value||c.value},[$[3]||($[3]=t("span",{class:"btn-icon"},"🚶‍♂️",-1)),$[4]||($[4]=t("span",{class:"btn-text"},"Flytta Hit",-1)),t("span",na,k(_.value)+" token"+k(_.value>1?"s":""),1)],10,sa)])):A("",!0),e.canShoot&&p.value.length>0?(h(),y("div",oa,[p.value.length===1?(h(),y("div",la,[t("button",{onClick:$[2]||($[2]=T=>I("shot",p.value[0].uuid)),class:j(["action-btn shoot-btn",{disabled:!l.value||c.value}]),disabled:!l.value||c.value},[$[5]||($[5]=t("span",{class:"btn-icon"},"🎯",-1)),t("span",ia,"Skjut "+k(p.value[0].playerID),1),$[6]||($[6]=t("span",{class:"btn-cost"},"1 token",-1))],10,ra)])):A("",!0)])):A("",!0),!e.canMove&&!e.canShoot?(h(),y("div",ua,[e.currentPlayer?e.currentPlayer.lives<=0?(h(),y("p",ca,"Du är död och kan inte utföra handlingar")):!P.value&&i.value>0?(h(),y("p",va," Du har inte råd att flytta hit ("+k(_.value)+" tokens behövs, du har "+k(e.currentPlayer.tokens)+") ",1)):D.value&&e.otherPlayers.length===0?(h(),y("p",fa," Du kan inte flytta till din egen position ")):D.value?(h(),y("p",ha,"Cell upptagen av annan spelare")):(h(),y("p",pa,"Ingen giltig handling")):(h(),y("p",da,"Du måste vara inloggad för att spela"))])):A("",!0)]),t("div",ga,[t("div",ya,[t("span",null,"Avstånd: "+k(i.value),1),e.currentPlayer&&e.otherPlayers.length>0?(h(),y("span",ma,"Räckvidd: "+k(e.currentPlayer.range),1)):A("",!0)]),t("div",ba,[S.value?A("",!0):(h(),y("span",ka,"⚠️ Avstängd zon"))])])],4)):A("",!0)}},wa=be(_a,[["__scopeId","data-v-93f02644"]]);function Pa(e,o,s,n="explosion",c){const b=[],p=n==="explosion"?25:10,i=["#FFD700","#FF4500","#FF6347","#DC143C","#8B0000","#000000"];for(let P=0;P<p;P++){const l=Math.random()*Math.PI*2,S=s*(.07+Math.random()*.16);b.push({x:0,y:0,vx:Math.cos(l)*S,vy:Math.sin(l)*S,size:Math.max(2,s*.08+Math.random()*(s*.06)),color:i[Math.floor(Math.random()*i.length)]||"#FF4500",life:1,maxLife:400+Math.random()*300})}const _={row:e,col:o,type:n,particles:b,active:!0,duration:800,elapsed:0};return c&&(_.onComplete=c),_}function Ma(e,o,s,n,c="click"){const b=[];for(let i=0;i<50;i++){const _=i/50*Math.PI*2+(Math.random()-.5)*.5,P=s*(.06+Math.random()*.16);b.push({x:0,y:0,vx:Math.cos(_)*P,vy:Math.sin(_)*P,size:Math.max(1.5,s*.06+Math.random()*(s*.04)),color:n,life:1,maxLife:300+Math.random()*250})}return{row:e,col:o,type:c,particles:b,active:!0,duration:350,elapsed:0,rippleRadius:0,rippleMaxRadius:Math.max(s*.9,14),rippleAlpha:1,playerColor:n}}function Ca(e,o,s,n,c){const b=Math.sqrt(Math.pow(s-e,2)+Math.pow(n-o,2)),i=12/Math.max(1,b),_={startX:e,startY:o,endX:s,endY:n,currentX:e,currentY:o,progress:0,active:!0,speed:i};return c&&(_.onComplete=c),_}function Sa(e,o,s,n,c,b=2){return{startRow:e,startCol:o,endRow:s,endCol:n,currentRow:e,currentCol:o,tankUuid:c,phase:e!==s?"row":"col",progress:0,active:!0,speed:b}}function Da(e,o){if(!e.active)return e;const s=e.active;return e.elapsed+=o,e.particles.forEach(n=>{n.x+=n.vx,n.y+=n.vy,n.life-=o/n.maxLife,n.vy+=.001*o,n.vx*=.98,n.vy*=.98}),e.particles=e.particles.filter(n=>n.life>0),(e.elapsed>=e.duration||e.particles.length===0)&&(e.active=!1,s&&e.onComplete&&e.onComplete()),e}function Aa(e,o){if(!e.active)return e;e.elapsed+=o;const s=e.elapsed/e.duration;if(s>=1)return e.active=!1,e;const n=1-Math.pow(1-s,3);return e.rippleRadius=n*e.rippleMaxRadius,e.rippleAlpha=1-n,e.particles.forEach(c=>{c.life-=o/c.maxLife,c.x+=c.vx,c.y+=c.vy,c.vx*=.985,c.vy*=.985}),e.particles=e.particles.filter(c=>c.life>0),e}function $a(e,o){if(!e.active)return e;const s=e.progress>=1;return e.progress+=e.speed*o*.01,e.progress>=1&&(e.progress=1,e.active=!1,!s&&e.onComplete&&e.onComplete()),e.currentX=e.startX+(e.endX-e.startX)*e.progress,e.currentY=e.startY+(e.endY-e.startY)*e.progress,e}function Ta(e,o){if(!e.active)return e;e.progress>=1&&e.phase==="col"&&(e.currentRow,e.endRow);const s=e.speed*o*.001;if(e.phase==="row"){const n=Math.abs(e.endRow-e.startRow);n===0?(e.phase="col",e.progress=0):(e.progress+=s/n,e.progress>=1?(e.progress=1,e.currentRow=e.endRow,e.endCol!==e.startCol?(e.phase="col",e.progress=0):e.active=!1):e.currentRow=e.startRow+(e.endRow-e.startRow)*e.progress)}else if(e.phase==="col"){const n=Math.abs(e.endCol-e.startCol);n===0?e.active=!1:(e.progress+=s/n,e.progress>=1?(e.progress=1,e.currentCol=e.endCol,e.active=!1):e.currentCol=e.startCol+(e.endCol-e.startCol)*e.progress)}return e}function Ke(){return{explosions:[],bullets:[],clicks:[],tankMoves:[],lastUpdate:performance.now()}}function xa(e,o=performance.now()){const s=o-e.lastUpdate;return e.explosions=e.explosions.map(n=>Da(n,s)).filter(n=>n.active),e.clicks=e.clicks.map(n=>Aa(n,s)).filter(n=>n.active),e.bullets=e.bullets.map(n=>$a(n,s)).filter(n=>n.active),e.tankMoves=e.tankMoves.map(n=>Ta(n,s)).filter(n=>n.active),e.lastUpdate=o,e}function Ia(e,o,s,n,c="explosion",b){return he(e)||(e.lastUpdate=performance.now()),e.explosions.push(Pa(o,s,n,c,b)),e}function Ra(e,o,s,n,c){return he(e)||(e.lastUpdate=performance.now()),e.clicks.push(Ma(o,s,n,c)),e}function Fa(e,o,s,n,c,b=.05,p){return he(e)||(e.lastUpdate=performance.now()),e.bullets.push(Ca(o,s,n,c,p)),e}function Ea(e,o,s,n,c,b,p=2){return he(e)||(e.lastUpdate=performance.now()),e.tankMoves.push(Sa(o,s,n,c,b,p)),e}function he(e){return e.explosions.length>0||e.bullets.length>0||e.clicks.length>0||e.tankMoves.length>0}function La(e,o,s,n,c,b){o.explosions.forEach(p=>{const i=(p.col+.5)*s,_=(p.row+.5)*s;p.particles.forEach(P=>{const l=i+P.x,S=_+P.y,D=(l+c)*n,I=(S+b)*n,E=P.size*n*(.85+.35*P.life);e.save(),e.globalAlpha=Math.max(0,Math.min(1,P.life)),e.fillStyle=P.color,e.beginPath(),e.arc(D,I,E,0,Math.PI*2),e.fill(),e.restore()})}),o.clicks.forEach(p=>{const i=(p.col+.5)*s,_=(p.row+.5)*s;if(p.rippleAlpha>0){const P=(i+c)*n,l=(_+b)*n,S=p.rippleRadius*n;e.save(),e.strokeStyle=`rgba(224, 59, 75, ${Math.max(0,Math.min(.9,p.rippleAlpha))})`,e.lineWidth=Math.max(1,p.rippleAlpha*4),e.beginPath(),e.arc(P,l,S,0,Math.PI*2),e.stroke(),e.restore()}p.particles.forEach(P=>{const l=i+P.x,S=_+P.y,D=(l+c)*n,I=(S+b)*n,E=P.size*n*(.85+.35*P.life);e.save(),e.globalAlpha=Math.max(0,Math.min(1,P.life)),e.fillStyle=P.color,e.beginPath(),e.arc(D,I,E,0,Math.PI*2),e.fill(),e.restore()})}),o.bullets.forEach(p=>{const i=(p.currentX+c)*n,_=(p.currentY+b)*n,P=Math.max(2,s*.1)*n;e.save(),e.fillStyle="#000000",e.beginPath(),e.arc(i,_,P,0,Math.PI*2),e.fill(),e.restore()})}function Ba(e,o){const s=e.tankMoves.find(n=>n.tankUuid===o&&n.active);return s?{row:s.currentRow,col:s.currentCol}:null}const Ua={class:"canvas-controls"},Ga={key:1,class:"loading-overlay"},Ya={key:0,class:"debug-overlay"},Xa={class:"debug-item"},za={class:"debug-item"},Ka={class:"debug-item"},Oa={class:"debug-item"},Oe=4,Ve=16/24,Va=mt({__name:"BandvagnCanvas",emits:["actionPerformed"],setup(e,{expose:o,emit:s}){const n=De(),c=s,b=w(null),p=w(null),i=w(null),_=w(800),P=w(600),l=w(30),S=w(1),D=w({x:0,y:0}),I=w(!1),E=w(!1),$=w(!1),T=w({x:0,y:0}),ne=w(!1),z=w(window.devicePixelRatio||1),q=w(null),X=w(!1),H=w({x:0,y:0}),M=w(null),C=w(0),U=w(!1),L=w(Ke()),K=w(0),ke=w(!0),N=w({bg:"#000",grid:"#333",text:"#444",modalHeader:"#ff6"}),J=w("12px Arial, sans-serif");function Q(){const a=b.value??document.documentElement,u=getComputedStyle(a);N.value={bg:u.getPropertyValue("--canvas-bg-color").trim()||"#000",grid:u.getPropertyValue("--canvas-grid-color").trim()||"#333",text:u.getPropertyValue("--canvas-text-color").trim()||"#444",modalHeader:u.getPropertyValue("--modal-header-color").trim()||"#ff6"};const v=u.getPropertyValue("--theme-font-family").trim()||"Arial, sans-serif",r=Math.max(10,Math.floor(l.value*.35));J.value=`${r}px ${v}`}const g=F(()=>n.allPlayers.find(a=>a.uuid===n.currentPlayer?.uuid)||null),d=F(()=>n.allPlayers),m=F(()=>(console.log("gameStore.boardData",n.boardData),n.boardData?{rows:n.boardData.rows,cols:n.boardData.cols}:{rows:0,cols:0})),oe=F(()=>{const a=n.boardData?.shrink||0;return{rows:Math.max(1,m.value.rows-a*2),cols:Math.max(1,m.value.cols-a*2),shrink:a}}),pe=F(()=>M.value?n.allPlayers.filter(a=>a.position.row===M.value.row&&a.position.column===M.value.col&&a.uuid!==n.currentPlayer?.uuid):[]),_e=F(()=>!M.value||!n.currentPlayer?!1:n.canMoveToCell(M.value.row,M.value.col)),we=F(()=>{if(!M.value||!n.currentPlayer||pe.value.filter(f=>f.lives>0).length===0)return!1;const{row:u,col:v}=M.value,r=Math.abs(u-g.value.position.row)+Math.abs(v-g.value.position.column);return r<=g.value.range&&r>0&&g.value.tokens>=1});function He(a){let u=a.clientWidth,v=a.clientHeight;if(!u||!v){const r=a.getBoundingClientRect(),f=getComputedStyle(a),x=parseFloat(f.borderLeftWidth||"0")+parseFloat(f.borderRightWidth||"0"),R=parseFloat(f.borderTopWidth||"0")+parseFloat(f.borderBottomWidth||"0");u=Math.max(0,Math.floor(r.width-x)),v=Math.max(0,Math.floor(r.height-R))}return{width:u,height:v}}function Ae(){const a=p.value,u=b.value;if(!a||!u)return;const{width:v,height:r}=He(u),f=Math.max(1,Math.floor(v)),x=Math.max(1,Math.floor(r));f===_.value&&x===P.value||(_.value=f,P.value=x,z.value=window.devicePixelRatio||1,a.width=Math.floor(_.value*z.value),a.height=Math.floor(P.value*z.value),i.value=a.getContext("2d"),i.value&&(i.value.setTransform(z.value,0,0,z.value,0,0),i.value.imageSmoothingEnabled=!1,l.value=30,Q(),B(1)))}function Ne(){i.value&&(m.value.rows<=0||m.value.cols<=0||(i.value.clearRect(0,0,_.value,P.value),i.value.save(),i.value.scale(S.value,S.value),i.value.translate(D.value.x,D.value.y),et(),Ze(),M.value&&at(M.value.row,M.value.col),g&&st(),i.value.restore(),tt()))}function Ze(){for(const a of d.value){const v=Ba(L.value,a.uuid)||{row:a.position.row,col:a.position.column},r=v.col*l.value,f=v.row*l.value,x=a.taken_tank,R=a.lives>0;if(Je(i.value,r,f,l.value,a.color,R,x,a.uuid===g.value?.uuid),a.uuid===g.value?.uuid&&(i.value.strokeStyle=N.value.modalHeader,i.value.lineWidth=3,i.value.beginPath(),i.value.arc(r+l.value/2,f+l.value/2,l.value/2,0,Math.PI*2),i.value.stroke()),a.lives>0)if(a.lives>3)i.value.fillStyle="#e74c3c",i.value.font=`${Math.floor(l.value*.3)}px Arial`,i.value.textAlign="left",i.value.textBaseline="top",i.value.fillText(`${a.lives}❤`,r,f+1);else{i.value.fillStyle="#e74c3c";const O=l.value/8;for(let te=0;te<a.lives;te++){const V=r+5+te*(O+2),Z=f+5;i.value.fillRect(V,Z,O,O)}}}}function Je(a,u,v,r,f,x,R,O){a.save(),a.imageSmoothingEnabled=!1;const te=x?Math.min(1,Math.max(.4,(R?.7:.5)+.15)):.1;a.globalAlpha=te;const V=q.value;if(V&&V.complete&&V.naturalWidth>0&&V.naturalHeight>0){const Z=Math.max(1,r*.08);let ae=r-Z*2,se=ae*Ve;se>r-Z*2&&(se=r-Z*2,ae=se/Ve);const Pe=u+(r-se)/2,Me=v+(r-ae)/2,Y=document.createElement("canvas");Y.width=V.naturalWidth,Y.height=V.naturalHeight;const G=Y.getContext("2d");G.imageSmoothingEnabled=!1,G.clearRect(0,0,Y.width,Y.height),G.fillStyle=f,G.fillRect(0,0,Y.width,Y.height),G.globalCompositeOperation="multiply",G.drawImage(V,0,0),G.globalCompositeOperation="destination-in",G.drawImage(V,0,0),G.globalCompositeOperation="source-over",a.drawImage(Y,Pe,Me,se,ae)}else{const Z=r*.8,ae=r*.55,se=u+(r-Z)/2,Pe=v+(r-ae)/2,Me=Math.max(2,r*.08);a.fillStyle=f,a.strokeStyle=x?"#222":"#999",a.lineWidth=Math.max(1,r*.06),Qe(a,se,Pe,Z,ae,Me),a.fill(),a.stroke();const Y=r*.18,G=u+r/2,ie=v+r/2;a.beginPath(),a.arc(G,ie,Y,0,Math.PI*2),a.fillStyle="#fff8",a.fill(),a.stroke();const ge=Math.max(2,r*.08),Ue=r*.35;a.beginPath(),a.moveTo(G-ge/2,ie-Y),a.lineTo(G-ge/2,ie-Y-Ue),a.lineTo(G+ge/2,ie-Y-Ue),a.lineTo(G+ge/2,ie-Y),a.closePath(),a.fillStyle="#222a",a.fill()}a.restore()}function Qe(a,u,v,r,f,x){const R=Math.min(x,r/2,f/2);a.beginPath(),a.moveTo(u+R,v),a.lineTo(u+r-R,v),a.quadraticCurveTo(u+r,v,u+r,v+R),a.lineTo(u+r,v+f-R),a.quadraticCurveTo(u+r,v+f,u+r-R,v+f),a.lineTo(u+R,v+f),a.quadraticCurveTo(u,v+f,u,v+f-R),a.lineTo(u,v+R),a.quadraticCurveTo(u,v,u+R,v),a.closePath()}function et(){if(!i.value)return;const a=m.value.rows,u=m.value.cols,v=oe.value.shrink;i.value.fillStyle=N.value.bg,i.value.save(),i.value.setTransform(1,0,0,1,0,0),i.value.fillRect(0,0,p.value.width,p.value.height),i.value.restore(),i.value.strokeStyle=N.value.grid,i.value.lineWidth=.5;for(let r=0;r<=u;r++){const f=Math.floor(r*l.value);i.value.beginPath(),i.value.moveTo(f,0),i.value.lineTo(f,a*l.value),i.value.stroke()}for(let r=0;r<=a;r++){const f=Math.floor(r*l.value)+.5;i.value.beginPath(),i.value.moveTo(0,f),i.value.lineTo(u*l.value,f),i.value.stroke()}if(v>0){i.value.fillStyle="rgba(240, 60, 80, 0.3)";for(let r=0;r<=a-1;r++)for(let f=0;f<=u-1;f++)(r<v||r>=a-v||f<v||f>=u-v)&&i.value.fillRect(f*l.value,r*l.value,l.value,l.value)}i.value.fillStyle=N.value.text,i.value.font=J.value,i.value.textAlign="center",i.value.textBaseline="top";for(let r=0;r<u;r++){const f=r*l.value+l.value/2;i.value.fillText(String(r),f,5-Math.min(D.value.y,l.value))}i.value.textAlign="left",i.value.textBaseline="middle";for(let r=0;r<a;r++){const f=r*l.value+l.value/2;i.value.fillText(String(r),5-Math.min(D.value.x,l.value),f)}}function tt(){i.value&&(L.value=xa(L.value),La(i.value,L.value,l.value,S.value,D.value.x,D.value.y))}function $e(){const a=I.value||U.value||E.value||he(L.value);a?K.value=10:K.value>0&&(K.value-=1),(a||K.value>0)&&Ne(),requestAnimationFrame($e)}function B(a=3){K.value=Math.max(K.value,a)}function at(a,u){const v=u*l.value,r=a*l.value;i.value.strokeStyle=N.value.modalHeader,i.value.lineWidth=3,i.value.setLineDash([5,5]),i.value.strokeRect(v,r,l.value,l.value),i.value.setLineDash([])}function st(){if(!g||!i.value)return;const a=g.value.range,u=g.value.position.row,v=g.value.position.column;i.value.fillStyle="rgba(76, 175, 80, 0.15)";for(let r=u-a;r<=u+a;r++)for(let f=v-a;f<=v+a;f++){const x=Math.abs(r-u)+Math.abs(f-v);if(x<=a&&x>0&&r>=0&&f>=0&&r<m.value.rows&&f<m.value.cols){const R=f*l.value,O=r*l.value;i.value.fillRect(R,O,l.value,l.value)}}}function nt(a,u){const v=p.value.getBoundingClientRect(),r=(a-v.left)/S.value-D.value.x,f=(u-v.top)/S.value-D.value.y,x=Math.floor(r/l.value);return{row:Math.floor(f/l.value),col:x}}function Te(a,u){const v=(u*l.value+D.value.x)*S.value,r=(a*l.value+D.value.y)*S.value;return{x:v,y:r}}function ot(a){if(I.value||$.value)return;const{row:u,col:v}=nt(a.clientX,a.clientY);if(u<0||v<0||u>=m.value.rows||v>=m.value.cols)return;if(M.value&&M.value.row===u&&M.value.col===v){console.log("Cell clicked again, toggling popup off"),X.value=!X.value,M.value=null,B(1);return}M.value={row:u,col:v},console.log("Cell clicked:",u,v);const r=d.value.find(R=>R.position.row===u&&R.position.column===v);r&&(L.value=Ra(L.value,u,v,l.value,r.color),B(5));const{x:f,y:x}=Te(u,v);H.value={x:Math.min(f+50,_.value-250),y:Math.max(x-250,0)},X.value=!0,B(1)}function lt(a){I.value=!0,$.value=!1,T.value={x:a.clientX,y:a.clientY}}function rt(a){if(!I.value)return;const u=a.clientX-T.value.x,v=a.clientY-T.value.y;(Math.abs(u)>Oe||Math.abs(v)>Oe)&&($.value=!0),D.value.x+=u/S.value,D.value.y+=v/S.value,T.value={x:a.clientX,y:a.clientY},B(10)}function xe(){I.value=!1,B(5)}function it(a){E.value=!0;const u=a.deltaY>0?.9:1.1,v=Math.max(.5,Math.min(3,S.value*u)),r=p.value.getBoundingClientRect(),f=a.clientX-r.left,x=a.clientY-r.top,R=f/S.value-D.value.x,O=x/S.value-D.value.y;D.value.x=f/v-R,D.value.y=x/v-O,S.value=v,B(10),setTimeout(()=>E.value=!1,0)}function ut(a){if(a.touches.length===1){const u=a.touches.item(0);T.value={x:u.clientX,y:u.clientY},I.value=!0,$.value=!1}else if(a.touches.length===2){U.value=!0;const u=a.touches.item(0),v=a.touches.item(1);C.value=Math.sqrt(Math.pow(v.clientX-u.clientX,2)+Math.pow(v.clientY-u.clientY,2))}}function dt(a){if(a.touches.length===1&&!U.value){const u=a.touches.item(0),v=u.clientX-T.value.x,r=u.clientY-T.value.y;(Math.abs(v)>5||Math.abs(r)>5)&&(D.value.x+=v/S.value,D.value.y+=r/S.value,B(10)),T.value={x:u.clientX,y:u.clientY},B(10)}else if(a.touches.length===2){const u=a.touches.item(0),v=a.touches.item(1),r=Math.sqrt(Math.pow(v.clientX-u.clientX,2)+Math.pow(v.clientY-u.clientY,2)),f=r/C.value,x=Math.max(.5,Math.min(3,S.value*f));S.value=x,C.value=r,U.value=!0,B(10)}}function ct(){I.value=!1,U.value=!1}function vt(){S.value=1,D.value={x:0,y:0},B(5)}function Ie(a){if(!a)return;console.log("Centering on player",a.name,a.position);const u=_.value/2,v=P.value/2;D.value.x=u/S.value-(a.position.column*l.value+l.value/2),D.value.y=v/S.value-(a.position.row*l.value+l.value/2),M.value={row:a.position.row,col:a.position.column};const{x:r,y:f}=Te(a.position.row,a.position.column);H.value={x:Math.min(r+50,_.value-250),y:Math.max(f-250,0)},X.value=!0,B(3)}function Re(a,u,v){L.value=Ia(L.value,a,u,l.value,"explosion",v),B(10)}function Fe(a,u,v,r,f){const x=(u+.5)*l.value,R=(a+.5)*l.value,O=(r+.5)*l.value,te=(v+.5)*l.value;L.value=Fa(L.value,x,R,O,te,.05,f),B(10)}function Ee(a,u,v,r,f){L.value=Ea(L.value,u,v,r,f,a,2),B(10)}function ft(a,u,v,r,f){Fe(a,u,v,r,()=>{Re(v,r,f)})}o({triggerExplosion:Re,triggerBullet:Fe,triggerBulletAndExplosion:ft,triggerTankMove:Ee,centerOnPlayer:Ie});function ht(a){if(a.action==="move"&&g.value){const u=g.value.position.row,v=g.value.position.column,r=a.targetCell.row,f=a.targetCell.col,x={...a,animationTrigger:{triggerTankMove:()=>{Ee(g.value.uuid,u,v,r,f)}}};c("actionPerformed",x)}else c("actionPerformed",a);Le()}function Le(){X.value=!1,M.value=null}let ee=null;function Be(){ee!==null&&cancelAnimationFrame(ee),ee=requestAnimationFrame(()=>{ee=null,Ae(),B(2)})}return Ce(()=>[d.value,n.boardData,g.value],()=>{bt(()=>B(3))},{deep:!0}),Ce(()=>l.value,()=>{Q(),B(2)}),Se(()=>{Ae(),window.addEventListener("resize",Be);const a=new Image;a.src="/assets/bandvagn no shadow.png",a.decoding="async",a.onload=()=>{q.value=a,B(2)},Q(),$e(),B(1)}),je(()=>{ee!==null&&(cancelAnimationFrame(ee),ee=null),window.removeEventListener("resize",Be),K.value=0,L.value=Ke()}),(a,u)=>(h(),y(ce,null,[t("div",{class:"canvas-container",ref_key:"containerRef",ref:b},[t("canvas",{ref_key:"canvasRef",ref:p,class:"game-canvas",onClick:ot,onMousedown:lt,onMousemove:rt,onMouseup:xe,onMouseleave:xe,onWheel:ue(it,["prevent"]),onTouchstart:ue(ut,["prevent"]),onTouchmove:ue(dt,["prevent"]),onTouchend:ue(ct,["prevent"])},null,544),X.value&&M.value?(h(),ye(wa,{key:0,cell:M.value,"current-player":g.value,"other-players":pe.value,"can-move":_e.value,"can-shoot":we.value,position:H.value,onAction:ht,onClose:Le},null,8,["cell","current-player","other-players","can-move","can-shoot","position"])):A("",!0),t("div",Ua,[t("button",{onClick:vt,class:"control-btn",title:"Reset zoom"},"(0,0)"),g.value?(h(),y("button",{key:0,onClick:u[0]||(u[0]=v=>Ie(g.value)),class:"control-btn",title:"Center on player"}," 🎯 ")):A("",!0)]),ne.value?(h(),y("div",Ga,[...u[1]||(u[1]=[t("div",{class:"loading-spinner"},"⏳",-1),t("p",null,"Laddar spel...",-1)])])):A("",!0)],512),ke.value?(h(),y("div",Ya,[t("div",Xa,"Canvas: "+k(_.value)+"x"+k(P.value)+" @ "+k(z.value)+"x",1),t("div",za,"Cell Size: "+k(l.value)+"px",1),t("div",Ka," Zoom: "+k(S.value.toFixed(2))+", Pan: ("+k(D.value.x.toFixed(1))+", "+k(D.value.y.toFixed(1))+") ",1),t("div",Oa,"Animation Frames Remaining: "+k(K.value),1)])):A("",!0)],64))}}),Wa=be(Va,[["__scopeId","data-v-5232ce72"]]),ja={id:"app-container"},qa={class:"stats-container"},Ha={class:"stats-content"},Na={key:0,class:"stats-grid"},Za={class:"stat-item"},Ja={class:"stat-value"},Qa={class:"stat-item"},es={class:"stat-value"},ts={class:"stat-item"},as={class:"stat-value"},ss={class:"stat-item"},ns={class:"stat-value"},os={key:1,class:"no-player-message"},ls={key:2,class:"players-list"},rs={class:"players-list-header"},is={class:"players-list-items"},us={class:"player-name"},ds={class:"player-position"},cs={class:"player-distance"},vs={class:"player-focus"},fs=["onClick"],hs={class:"player-meta"},ps={class:"mobile-controls-bar"},gs={class:"mobile-top-row"},ys={key:0,class:"mobile-game-info"},ms={class:"mobile-tokens"},bs={class:"mobile-lives"},ks={class:"mobile-btn-container"},_s=["disabled"],ws={key:0},Ps={key:1},Ms={class:"game-layout"},Cs={class:"sidebar desktop-only"},Ss={class:"sidebar-btn-container"},Ds=["disabled"],As={key:0},$s={key:1},Ts={key:0},xs={key:1},Is={key:0,class:"action-buttons"},Rs=["disabled"],Fs=["disabled"],Es={class:"canvas-outer-wrapper"},Ls={class:"canvas-container"},Bs={key:1,class:"upgrade-modal auth-form"},Us={class:"form-base"},Gs={key:0},Ys={key:1},Xs={key:3,class:"loading-container"},zs={key:4,class:"no-player-container"},Ks={key:0},Os={key:0,class:"mobile-actions"},Vs=["disabled"],Ws=["disabled"],js={class:"sidebar desktop-only"},qs={key:0,class:"game-info"},Hs={class:"info-item"},Ns={class:"info-value"},Zs={class:"info-item"},Js={class:"info-value"},Qs={class:"info-item"},en={class:"info-value"},tn={class:"info-item"},an={class:"info-value"},sn={class:"info-item"},nn={key:1,class:"game-logs"},on={class:"logs-container"},ln={class:"log-header"},rn={class:"log-timestamp"},un={class:"log-content"},dn={class:"log-action"},cn={key:0,class:"mobile-stats"},vn={class:"mobile-stats-grid"},fn={class:"mobile-stat-item"},hn={class:"mobile-stat-value"},pn={class:"mobile-stat-item"},gn={key:1,class:"information-container"},yn={__name:"Kfkbandvagn",setup(e){const o=w(null),s=re(),n=De(),c=w(!1),b=w(!1),p=w(!1),i=w(!1),_=w(""),P=w(!1),l=F(()=>n.currentPlayer),S=F(()=>n.allPlayers),D=F(()=>n.boardData),I=F(()=>n.isLoading),E=F(()=>(console.log("Game initialized:",n.initialized,l.value),l.value)),$=F(()=>S.value.filter(d=>d.taken_tank).map(d=>({...d,distToCurrent:l.value?Math.abs(d.position.row-l.value.position.row)+Math.abs(d.position.column-l.value.position.column):1/0})).sort((d,m)=>d.distToCurrent-m.distToCurrent)),T=F(()=>D.value?.logs?D.value.logs.slice().reverse():[]);function ne(){c.value=!c.value}function z(){b.value=!b.value}async function q(){try{await n.fetchGameState()}catch(g){console.error("Failed to refresh game state:",g)}}function X(){p.value=!0}function H(){p.value=!1}function M(){p.value=!1,q()}function C(g){o.value.centerOnPlayer(g)}async function U(g){try{g.action==="shot"&&o.value&&(g.animationTrigger={triggerBulletAndExplosion:o.value.triggerBulletAndExplosion}),await n.performAction(g)}catch(d){console.error("Action failed:",d)}}function L(g){_.value=g,i.value=!0}function K(){i.value=!1,_.value=""}async function ke(){console.log("Confirming upgrade:",_.value);try{await n.performAction({action:_.value,tank_id:l.value?.uuid||""}),i.value=!1,_.value="",console.log("Upgrade successful")}catch(g){console.error("Upgrade failed:",g)}}function N(g){const d=new Date(g),m=d.getFullYear().toString().slice(-2),oe=String(d.getMonth()+1).padStart(2,"0"),pe=String(d.getDate()).padStart(2,"0"),_e=String(d.getHours()).padStart(2,"0"),we=String(d.getMinutes()).padStart(2,"0");return`${m}-${oe}-${pe} ${_e}:${we}`}function J(g){const d=l.value&&g.playerID===l.value.playerID;let m="";switch(g.action){case"shot":g.details?.targetUser?m=`Sköt ${g.details.targetUser} (${g.details.targetUserLives} liv kvar)`:m="Sköt";break;case"move":g.details?.position?m=`Flyttade till (${g.details.position.row}, ${g.details.position.column})`:m="Flyttade";break;case"range":g.details?.range?m=`Köpte räckvidd (${g.details.range-1} → ${g.details.range})`:m="Köpte räckvidd";break;case"life":g.details?.lives?m=`Köpte liv (${g.details.lives-1} → ${g.details.lives})`:m="Köpte liv";break;case"board_shrink":m="Spelplanen krympte";break;case"token_distribution":g.details?.tokensGiven?m=`Alla fick ${g.details.tokensGiven} tokens`:m="Alla fick tokens";break;case"death":g.details?.targetUser?m=`${g.details.targetUser} dog`:m="Någon dog";break;case"respawn":m="Återuppstod";break;default:m=g.action;break}return{timestamp:N(g.timestamp),playerID:g.playerID,actionDescription:m,isCurrentPlayer:d}}function Q(){P.value=window.innerWidth<=768}return Ce(()=>s.authStateVersion,async(g,d)=>{if(console.log(`Auth state version changed: ${d} -> ${g}`),s.isAuthed){if(!n.initialized){console.log("User authenticated, initializing game store");try{await n.initialize(),l.value?p.value=!1:p.value=!0}catch(m){console.error("Failed to initialize game store after auth change:",m)}}}else console.log("User logged out, resetting game store"),n.reset(),p.value=!1},{immediate:!1}),Se(async()=>{if(Q(),window.addEventListener("resize",Q),s.isAuthed){console.log("User authenticated, initializing game store");try{await n.initialize()}catch(g){console.error("Failed to initialize game store on mount:",g)}}}),je(()=>{window.removeEventListener("resize",Q)}),(g,d)=>(h(),y("div",ja,[d[31]||(d[31]=t("h1",{class:"game-header"},"KfKbandvagn",-1)),t("div",qa,[t("button",{onClick:z,class:"stats-toggle"},[d[4]||(d[4]=t("span",null,"Spelstatus",-1)),t("span",{class:j(["toggle-icon",{expanded:b.value}])},"▼",2)]),t("div",{class:j(["stats-wrapper",{expanded:b.value}])},[t("div",Ha,[l.value?(h(),y("div",Na,[t("div",Za,[d[5]||(d[5]=t("span",{class:"stat-label"},"Spelare",-1)),t("span",Ja,k(l.value.playerID),1)]),t("div",Qa,[d[6]||(d[6]=t("span",{class:"stat-label"},"Tokens",-1)),t("span",es,k(l.value.tokens),1)]),t("div",ts,[d[7]||(d[7]=t("span",{class:"stat-label"},"Liv",-1)),t("span",as,k(l.value.lives),1)]),t("div",ss,[d[8]||(d[8]=t("span",{class:"stat-label"},"Räckvidd",-1)),t("span",ns,k(l.value.range),1)])])):(h(),y("div",os,[...d[9]||(d[9]=[t("p",null,"Ingen aktiv spelare - logga in eller skapa en bandvagn",-1)])])),$.value.length?(h(),y("div",ls,[t("div",rs,[t("span",null,"Spelare på brädet ("+k($.value.length)+")",1)]),t("ul",is,[d[10]||(d[10]=Xe('<li style="border-bottom:1px solid var(--theme-border-light);" data-v-e0dd17bf><span class="players-list-header" data-v-e0dd17bf>Namn</span><span class="players-list-header" data-v-e0dd17bf>Position (r,c)</span><span class="players-list-header" data-v-e0dd17bf>Distans</span><span class="players-list-header" data-v-e0dd17bf>Visa</span><span data-v-e0dd17bf></span></li>',1)),(h(!0),y(ce,null,me($.value,m=>(h(),y("li",{key:m.uuid,class:"players-list-item"},[t("div",null,[m.uuid===l.value?.uuid?(h(),y("span",{key:0,class:"current-player-indicator",style:ve({color:m.color,background:"#ffd70099",borderRadius:"5px"})},"★",4)):A("",!0),m.uuid!==l.value?.uuid?(h(),y("span",{key:1,class:"player-dot",style:ve({backgroundColor:m.color})},null,4)):A("",!0),t("span",us,k(m.playerID),1)]),t("span",ds,k(m.position.row)+", "+k(m.position.column),1),t("span",cs,k(m.distToCurrent),1),t("span",vs,[t("button",{onClick:oe=>C(m)},"🔍",8,fs)]),t("span",hs,"❤ "+k(m.lives)+" · ➶ "+k(m.range)+" · ⛁ "+k(m.tokens),1)]))),128))])])):A("",!0)])],2)]),t("div",ps,[t("div",gs,[l.value?(h(),y("div",ys,[t("span",ms,k(l.value.tokens)+" tokens",1),t("span",bs,k(l.value.lives)+" liv",1)])):A("",!0),t("div",ks,[t("button",{onClick:q,class:"mobile-btn",disabled:I.value},[I.value?(h(),y("span",ws,"⏳")):(h(),y("span",Ps,"🔄"))],8,_s),t("button",{onClick:ne,class:"mobile-btn"},"ℹ️")])])]),t("div",Ms,[t("div",Cs,[t("div",Ss,[t("button",{onClick:q,class:"sidebar-btn",disabled:I.value},[I.value?(h(),y("span",As,"Laddar...")):(h(),y("span",$s,"Uppdatera"))],8,Ds),t("button",{onClick:ne,class:"sidebar-btn"},[c.value?(h(),y("span",Ts,"Dölj Info")):(h(),y("span",xs,"Visa Info"))])]),l.value&&l.value.lives>0?(h(),y("div",Is,[t("button",{onClick:d[0]||(d[0]=m=>L("range")),class:"action-btn",disabled:l.value.tokens<3},[...d[11]||(d[11]=[W(" Köp Räckvidd ",-1),t("br",null,null,-1),W(" (3 tokens) ",-1)])],8,Rs),t("button",{onClick:d[1]||(d[1]=m=>L("life")),class:"action-btn",disabled:l.value.tokens<3},[...d[12]||(d[12]=[W(" Köp Liv ",-1),t("br",null,null,-1),W(" (3 tokens) ",-1)])],8,Fs)])):A("",!0)]),t("div",Es,[t("div",Ls,[p.value?(h(),ye(qt,{key:0,onClose:H,onPlayerCreated:M})):A("",!0),i.value?(h(),y("div",Bs,[t("div",Us,[d[17]||(d[17]=t("h3",null,"Bekräfta Köp",-1)),_.value==="range"?(h(),y("p",Gs,[d[13]||(d[13]=W(" Vill du köpa ökad räckvidd för 3 tokens?",-1)),d[14]||(d[14]=t("br",null,null,-1)),W(" Din nuvarande räckvidd: "+k(l.value?.range||0),1)])):A("",!0),_.value==="life"?(h(),y("p",Ys,[d[15]||(d[15]=W(" Vill du köpa ett extra liv för 3 tokens?",-1)),d[16]||(d[16]=t("br",null,null,-1)),W(" Dina nuvarande liv: "+k(l.value?.lives||0),1)])):A("",!0),t("div",{class:"button-group"},[t("button",{onClick:K,class:"button-base decline"},"Avbryt"),t("button",{onClick:ke,class:"button-base"},"Köp")])])])):A("",!0),E.value?(h(),ye(Wa,{key:2,ref_key:"canvasRef",ref:o,onActionPerformed:U},null,512)):I.value?(h(),y("div",Xs,[...d[18]||(d[18]=[t("div",{class:"loading-spinner"},"⏳",-1),t("p",null,"Laddar spel...",-1)])])):(h(),y("div",zs,[d[21]||(d[21]=t("h2",null,"Välkommen till KfKbandvagn!",-1)),t("p",null,[d[19]||(d[19]=W(" Du behöver ",-1)),le(s).isAuthed?A("",!0):(h(),y("span",Ks,"logga in och")),d[20]||(d[20]=W(" skapa en bandvagn för att spela. ",-1))]),t("button",{onClick:X,class:"button-base"},"Skapa Bandvagn")]))]),l.value&&l.value.lives>0?(h(),y("div",Os,[t("button",{onClick:d[2]||(d[2]=m=>L("range")),class:"mobile-action-btn",disabled:l.value.tokens<3}," Räckvidd (3t) ",8,Vs),t("button",{onClick:d[3]||(d[3]=m=>L("life")),class:"mobile-action-btn",disabled:l.value.tokens<3}," Liv (3t) ",8,Ws)])):A("",!0)]),t("div",js,[l.value?(h(),y("div",qs,[t("div",Hs,[d[22]||(d[22]=t("span",{class:"info-label"},"Position",-1)),t("span",Ns,k(l.value.position.row)+", "+k(l.value.position.column),1)]),t("div",Zs,[d[23]||(d[23]=t("span",{class:"info-label"},"Tokens",-1)),t("span",Js,k(l.value.tokens),1)]),t("div",Qs,[d[24]||(d[24]=t("span",{class:"info-label"},"Liv",-1)),t("span",en,k(l.value.lives),1)]),t("div",tn,[d[25]||(d[25]=t("span",{class:"info-label"},"Räckvidd",-1)),t("span",an,k(l.value.range),1)]),t("div",sn,[d[26]||(d[26]=t("span",{class:"info-label"},"Status",-1)),t("span",{class:j(["info-value",{dead:l.value.lives<=0}])},k(l.value.lives>0?"Levande":"Död"),3)])])):A("",!0),D.value&&D.value.logs?(h(),y("div",nn,[d[27]||(d[27]=t("h4",null,"Senaste Händelser",-1)),t("div",on,[(h(!0),y(ce,null,me(T.value,(m,oe)=>(h(),y("div",{key:oe,class:"log-entry"},[t("div",ln,[t("span",rn,k(J(m).timestamp),1),t("span",{class:j(["log-player",{"current-player":J(m).isCurrentPlayer}])},k(J(m).playerID),3)]),t("div",un,[t("span",dn,k(J(m).actionDescription),1)])]))),128))])])):A("",!0)])]),l.value?(h(),y("div",cn,[t("div",vn,[t("div",fn,[d[28]||(d[28]=t("span",{class:"mobile-stat-label"},"Position",-1)),t("span",hn,k(l.value.position.row)+","+k(l.value.position.column),1)]),t("div",pn,[d[29]||(d[29]=t("span",{class:"mobile-stat-label"},"Status",-1)),t("span",{class:j(["mobile-stat-value",{dead:l.value.lives<=0}])},k(l.value.lives>0?"Levande":"Död"),3)])])])):A("",!0),c.value?(h(),y("div",gn,[...d[30]||(d[30]=[Xe('<div class="information-text" data-v-e0dd17bf><div class="background-decor" data-v-e0dd17bf><div class="information-inset" data-v-e0dd17bf><strong data-v-e0dd17bf>Spelregler</strong><p data-v-e0dd17bf> Varje spelare börjar på en slumpmässig plats på spelplanen med 3 hjärtan (liv), 2 rutor i räckvidd och 0 Tokens. Tokens förelas automatiskt dagligen. Använd tokens för att utföra handlingar. </p></div></div><div class="background-decor" data-v-e0dd17bf><div class="information-inset" data-v-e0dd17bf><strong data-v-e0dd17bf>Handlingar</strong><p data-v-e0dd17bf><strong data-v-e0dd17bf>Flytta:</strong> Klicka på en tom ruta för att flytta dit (1 token per ruta).<br data-v-e0dd17bf><strong data-v-e0dd17bf>Skjut:</strong> Klicka på en annan spelare inom din räckvidd för att skjuta (1 token). Om spelaren dör får du 5 tokens.<br data-v-e0dd17bf><strong data-v-e0dd17bf>Köp Räckvidd:</strong> Öka din räckvidd med 1 (3 tokens).<br data-v-e0dd17bf><strong data-v-e0dd17bf>Köp Liv:</strong> Få ett extra liv (3 tokens). </p></div></div><div class="background-decor" data-v-e0dd17bf><div class="information-inset" data-v-e0dd17bf><strong data-v-e0dd17bf>Liv och Dödsfall</strong><p data-v-e0dd17bf> Om du blir skjuten förlorar du ett liv. När du når 0 liv är du ute ur spelet (kom ihåg att köpa liv). Du kan återuppstå genom att en annan spelare donerar ett liv till dig. </p></div></div><div class="background-decor" data-v-e0dd17bf><div class="information-inset" data-v-e0dd17bf><strong data-v-e0dd17bf>Spelplan</strong><p data-v-e0dd17bf> Spelplanen krymper regelbundet och spelare utanför den aktiva ytan förlorar ett liv för varje gång spelplanen krymper. Nya tokens fördelas automatiskt till alla levande spelare. Planera dina drag väl! </p></div></div></div>',1)])])):A("",!0)]))}},bn=be(yn,[["__scopeId","data-v-e0dd17bf"]]);export{bn as default};
