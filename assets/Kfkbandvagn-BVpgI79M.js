import{A as Ce,G as dt,H as ct,B as re,_ as ke,r as A,j as E,o as Se,c as g,h,C as ye,D as vt,b as t,e as I,z as de,t as k,s as ce,f as Le,v as Ue,F as me,p as be,x as fe,y as H,I as ft,w as Oe,k as qe,n as ht,E as Be,d as J}from"./index-D8u7_wdt.js";class ve extends Error{code;status;constructor(o,n,s){super(o),this.name="BandvagnAPIError",this.code=n,this.status=s}}async function he(e,o="GET",n){console.log("Making request to endpoint:",e,"with method:",o,"and body:",n);try{const s={method:o};n&&(s.body=n);const{data:u,error:p}=await Ce.functions.invoke(`kfkbandvagn${e}`,s);if(console.log("Response data:",u,"Error:",p),p)throw console.error("Edge Function error:",p),new ve(p.message||"Request failed",p.name,p.status);if(u&&typeof u=="object"){if("success"in u&&u.success===!1){const f=u;throw new ve(f.error?.message||f.message||"Request failed",f.error?.code)}return"data"in u?u.data:u}return u}catch(s){throw s instanceof ve?s:(console.error("API request failed:",s),new ve(s instanceof Error?s.message:"Unknown API error"))}}function Ye(e){return e instanceof ve?{no_player_found:"Ingen spelare hittades",no_free_tanks:"Inga lediga tanks",missing_tokens:"Inte nog med tokens",invalid_action:"Ogiltigt drag",not_in_range:"Inte inom räckvidd",player_already_dead:"Spelaren är redan död",invalid_session:"Session har gått ut, logga in igen",validation_error:"Ogiltiga data",internal_error:"Serverfel, försök igen"}[e.code||""]||e.message||"Ett fel uppstod":e instanceof Error?e.message:"Ett oväntat fel uppstod"}async function Ve(){return he("/game/state","GET",void 0)}async function pt(){return he("/game/stats","GET",void 0)}const gt=Object.freeze(Object.defineProperty({__proto__:null,getGameState:Ve,getGameStats:pt},Symbol.toStringTag,{value:"Module"}));async function yt(e){return he("/auth/create","POST",e)}async function mt(e){return he("/auth/login","POST",e)}async function bt(e){return console.log("performGameAction called with action:",e),he("/game/action","POST",e)}const De=dt("bandvagn",{state:()=>({allPlayers:[],currentPlayer:null,boardData:null,initialized:!1,isLoading:!1,error:null,lastFetch:null,selectedCell:null,autoRefreshEnabled:!0,refreshInterval:36e5,refreshTimeoutId:null}),getters:{isPlayerAlive:e=>(e.currentPlayer?.lives||0)>0,canAffordUpgrade:e=>o=>(e.currentPlayer?.tokens||0)>=o,boardSize:e=>e.boardData?{rows:e.boardData.rows,cols:e.boardData.cols}:{rows:0,cols:0},playableBoardSize:e=>{if(!e.boardData)return{rows:0,cols:0};const o=e.boardData.shrink||0;return{rows:Math.max(1,e.boardData.rows-o*2),cols:Math.max(1,e.boardData.cols-o*2)}},recentLogs:e=>e.boardData?.logs?.slice(-20)||[],otherPlayers:e=>e.allPlayers.filter(o=>o.uuid!==e.currentPlayer?.uuid&&o.taken_tank),isDataFresh:e=>e.lastFetch?new Date().getTime()-e.lastFetch.getTime()<3e4:!1,gameStats:e=>{const o=e.allPlayers.filter(s=>s.lives>0&&s.taken_tank).length,n=e.allPlayers.filter(s=>s.taken_tank).length;return{alivePlayers:o,totalPlayers:n,boardShrink:e.boardData?.shrink||0}}},actions:{async initialize(){if(console.log("Initializing bandvagn store"),this.initialized){console.log("Bandvagn store already initialized, skipping");return}if(!re().isAuthed){console.warn("Cannot initialize bandvagn store - user not authenticated");return}this.isLoading=!0,this.error=null;try{await this.fetchGameState(),this.initialized=!0,this.autoRefreshEnabled&&this.startAutoRefresh(),console.log("Bandvagn store initialized successfully")}catch(o){console.error("Failed to initialize bandvagn store:",o),this.error=o instanceof Error?o.message:"Initialization failed"}finally{this.isLoading=!1}},async fetchGameState(){this.isLoading=!0,this.error=null;try{console.log("Fetching game state from server...");const e=await Ve();this.allPlayers=e.playerData||[],e.boardData&&(this.boardData={rows:e.boardData.size.rows,cols:e.boardData.size.columns,shrink:e.boardData.shrink,logs:e.boardData.logs,upgrades:e.boardData.upgrades||[],time_to_shrink:e.boardData.time_to_shrink||""}),await this.fetchCurrentUserTank(),this.lastFetch=new Date,console.log("Game state updated:",{players:this.allPlayers.length,currentPlayer:!!this.currentPlayer,boardSize:this.boardSize})}catch(e){throw console.error("Failed to fetch game state:",e),this.error=e instanceof Error?e.message:"Failed to fetch game state",e}finally{this.isLoading=!1}},async fetchCurrentUserTank(){const e=re();if(!e.user?.id)return this.currentPlayer=null,null;try{const{data:o,error:n}=await Ce.from("KfKbandvagn").select("user_id, playerID, uuid, tokens, position, lives, range, color, taken_tank").eq("user_id",e.user.id).maybeSingle();return n?(console.error("Failed to fetch current user's tank:",n),this.currentPlayer=null,null):!o||o.taken_tank===!1?(this.currentPlayer=null,null):(this.currentPlayer={uuid:o.uuid,playerID:o.playerID,position:o.position,lives:o.lives,tokens:o.tokens,range:o.range,taken_tank:o.taken_tank,color:o.color},this.currentPlayer)}catch(o){return console.error("Unexpected error fetching current user's tank:",o),this.currentPlayer=null,null}},async createPlayer(e){const o=re();if(!o.user?.id)throw new Error("User not authenticated");this.isLoading=!0,this.error=null;try{const n=await yt({user_id:o.user.id,playerID:e.playerID,color:e.color});return await this.fetchGameState(),n}catch(n){throw console.error("Failed to create player:",n),this.error=n instanceof Error?n.message:"Failed to create player",n}finally{this.isLoading=!1}},async loginPlayer(){const e=re();if(!e.user?.id)throw new Error("User not authenticated");this.isLoading=!0,this.error=null;try{const o=await mt({user_id:e.user.id});return await this.fetchGameState(),o}catch(o){throw console.error("Failed to login player:",o),this.error=o instanceof Error?o.message:"Failed to login player",o}finally{this.isLoading=!1}},async performAction(e){this.isLoading=!0,this.error=null;try{const o={action:e.action,tank_id:e.tank_id};e.action==="move"&&e.targetCell&&(o.moveDirection={row:e.targetCell.row,col:e.targetCell.col}),e.action==="shot"&&e.targetUUID&&(o.targetUUID=e.targetUUID),console.log("Performing action:",o);const n=await bt(o);if(console.log("Action result:",n),e.action==="shot"&&e.animationTrigger?.triggerBulletAndExplosion&&e.targetUUID&&this.currentPlayer){const s=this.allPlayers.find(u=>u.uuid===e.targetUUID);if(s){const u=this.currentPlayer.position,p=s.position;return this.currentPlayer=n.updatedData,e.animationTrigger.triggerBulletAndExplosion(u.row,u.column,p.row,p.column,()=>{if(n.shotData){const f=this.allPlayers.findIndex(r=>r.uuid===e.targetUUID);f!==-1&&(this.allPlayers[f]=n.shotData)}n.updatedLogs&&this.boardData&&(Array.isArray(n.updatedLogs)?this.boardData.logs=n.updatedLogs:this.boardData.logs=[...this.boardData.logs,n.updatedLogs])}),n}}if(e.action==="move"&&e.animationTrigger?.triggerTankMove&&this.currentPlayer){const s=n;return e.animationTrigger.triggerTankMove(()=>{if(s.updatedData){const u=this.allPlayers.findIndex(p=>p.uuid===s.updatedData?.uuid);u!==-1&&(this.allPlayers[u]=s.updatedData)}s.updatedLogs&&this.boardData&&(Array.isArray(s.updatedLogs)?this.boardData.logs=s.updatedLogs:this.boardData.logs=[...this.boardData.logs,s.updatedLogs])}),n}if(e.action!=="shot"&&!(e.action==="move"&&e.animationTrigger?.triggerTankMove)&&n.updatedData){const s=this.allPlayers.findIndex(u=>u.uuid===n.updatedData?.uuid);s!==-1&&(this.allPlayers[s]=n.updatedData),n.updatedLogs&&this.boardData&&(Array.isArray(n.updatedLogs)?this.boardData.logs=n.updatedLogs:this.boardData.logs=[...this.boardData.logs,n.updatedLogs])}return console.log("Game state refreshed successfully."),n}catch(o){throw console.error("Action failed:",o),this.error=o instanceof Error?o.message:"Action failed",o}finally{this.isLoading=!1}},async fetchGameStats(){try{const{getGameStats:e}=await ct(async()=>{const{getGameStats:n}=await Promise.resolve().then(()=>gt);return{getGameStats:n}},void 0);return await e()}catch(e){throw console.error("Failed to fetch game stats:",e),e}},startAutoRefresh(){this.refreshTimeoutId&&clearTimeout(this.refreshTimeoutId),this.refreshTimeoutId=window.setTimeout(async()=>{if(this.autoRefreshEnabled&&this.initialized){try{await this.fetchGameState()}catch(e){console.error("Auto-refresh failed:",e)}this.startAutoRefresh()}},this.refreshInterval)},stopAutoRefresh(){this.refreshTimeoutId&&(clearTimeout(this.refreshTimeoutId),this.refreshTimeoutId=null)},async forceRefresh(){this.lastFetch=null,await this.fetchGameState()},selectCell(e){this.selectedCell=e},canMoveToCell(e,o){if(!this.currentPlayer||(this.playableBoardSize,this.boardData?.shrink,e<0||e>=this.boardSize.rows||o<0||o>=this.boardSize.cols)||this.allPlayers.some(p=>p.position.row===e&&p.position.column===o&&p.lives>0&&p.uuid!==this.currentPlayer?.uuid)||this.currentPlayer.position.row===e&&this.currentPlayer.position.column===o)return!1;const s=Math.abs(e-this.currentPlayer.position.row)+Math.abs(o-this.currentPlayer.position.column),u=Math.max(1,s);return this.currentPlayer.tokens>=u},canShootAtCell(e,o){if(!this.currentPlayer||!this.allPlayers.find(u=>u.position.row===e&&u.position.column===o&&u.uuid!==this.currentPlayer?.uuid&&u.taken_tank&&u.lives>0))return!1;const s=Math.abs(e-this.currentPlayer.position.row)+Math.abs(o-this.currentPlayer.position.column);return s<=this.currentPlayer.range&&s>0},clearError(){this.error=null},setAutoRefresh(e){this.autoRefreshEnabled=e,e&&this.initialized?this.startAutoRefresh():this.stopAutoRefresh()},reset(){this.stopAutoRefresh(),this.allPlayers=[],this.currentPlayer=null,this.boardData=null,this.initialized=!1,this.isLoading=!1,this.error=null,this.lastFetch=null,this.selectedCell=null}}}),kt={class:"player-creation-container"},_t={key:1,class:"modal-overlay"},wt={class:"modal-content"},Pt={class:"player-creation-form"},Mt={key:0,class:"user-greeting"},Ct={key:1,class:"auth-prompt"},St={class:"button-group auth-buttons"},Dt={class:"form-group"},At=["disabled"],$t={class:"form-group"},Tt={class:"color-picker-container"},It=["disabled"],xt={class:"color-value"},Rt=["disabled"],Et={class:"preset-colors"},Ft={class:"color-presets"},Lt=["onClick","disabled"],Ut={key:0,class:"error-message"},Bt={key:1,class:"loading-state"},Yt={key:2,class:"button-group"},Gt={key:3,class:"existing-player-option"},Xt=["disabled"],zt={__name:"PlayerCreation",emits:["close","playerCreated"],setup(e,{emit:o}){const n=re(),s=De(),u=A(""),p=A("#4CAF50"),f=A(!1),r=A(""),_=A(!1),w=A(""),l=A(!0),S=["#4CAF50","#2196F3","#FF5722","#FF9800","#9C27B0","#607D8B","#795548","#E91E63","#00BCD4","#8BC34A","#FFC107","#3F51B5"],M=o;function F(D){w.value=D,_.value=!0}function U(){_.value=!1,w.value=""}function T(){_.value=!1,w.value="",n.fetchProfile()}const B=E(()=>u.value.length>=2&&u.value.length<=20&&/^[a-zA-Z0-9åäöÅÄÖ\s\-_.]*$/.test(u.value)&&/^#[0-9A-Fa-f]{6}$/.test(p.value));async function W(){if(!B.value){r.value="Kontrollera att alla fält är korrekt ifyllda";return}if(!n.isAuthed){r.value="Du måste vara inloggad för att skapa en spelare";return}f.value=!0,r.value="";try{await s.createPlayer({playerID:u.value.trim(),color:p.value}),console.log("Player created successfully"),M("playerCreated")}catch(D){console.error("Failed to create player:",D),r.value=Ye(D)}finally{f.value=!1}}async function ne(){if(!n.isAuthed){r.value="Du måste vara inloggad";return}f.value=!0,r.value="";try{await s.loginPlayer(),console.log("Player logged in successfully"),M("playerCreated")}catch(D){console.error("Failed to login existing player:",D),r.value=Ye(D),D.code==="no_player_found"&&(l.value=!1)}finally{f.value=!1}}function K(){M("close")}function Q(){const D=`#${Math.floor(Math.random()*16777215).toString(16).padStart(6,"0")}`;p.value=D}return Se(()=>{if(Q(),n.isAuthed&&n.profile?.username)u.value=n.profile.username;else if(n.user?.email){const D=n.user.email.split("@")[0];u.value=D.substring(0,15)}}),(D,P)=>(h(),g("div",kt,[_.value?(h(),ye(vt,{key:0,mode:w.value,onClose:U,onSuccess:T,class:"auth-form"},null,8,["mode"])):(h(),g("div",_t,[t("div",wt,[t("div",Pt,[t("button",{type:"button",class:"close-form-button",onClick:K},"×"),P[15]||(P[15]=t("h2",null,"Skapa din Bandvagn",-1)),de(n).isAuthed?(h(),g("div",Mt,[t("p",null,"Hej "+k(de(n).profile?.username||de(n).user?.email)+"!",1),P[4]||(P[4]=t("p",null,"Skapa din bandvagn för att börja spela.",-1))])):(h(),g("div",Ct,[P[5]||(P[5]=t("p",null,"Du behöver vara inloggad för att spela KfKbandvagn.",-1)),t("div",St,[t("button",{onClick:P[0]||(P[0]=G=>F("login")),class:"button-base"},"Logga In"),t("button",{onClick:P[1]||(P[1]=G=>F("signup")),class:"button-base"},"Skapa Konto")])])),de(n).isAuthed?(h(),g("form",{key:2,onSubmit:ce(W,["prevent"]),class:"creation-form"},[t("div",Dt,[P[6]||(P[6]=t("label",{for:"playerID",class:"form-label"},"Spelarnamn",-1)),Le(t("input",{"onUpdate:modelValue":P[2]||(P[2]=G=>u.value=G),type:"text",id:"playerID",class:"form-input",placeholder:"Ange ditt spelarnamn",disabled:f.value,required:"",minlength:"2",maxlength:"20"},null,8,At),[[Ue,u.value]]),P[7]||(P[7]=t("small",{class:"input-help"},"2-20 tecken, inga specialtecken",-1))]),t("div",$t,[P[8]||(P[8]=t("label",{for:"playerColor",class:"form-label"},"Bandvagnsfärg",-1)),t("div",Tt,[Le(t("input",{"onUpdate:modelValue":P[3]||(P[3]=G=>p.value=G),type:"color",id:"playerColor",class:"color-input",disabled:f.value},null,8,It),[[Ue,p.value]]),t("span",xt,k(p.value),1),t("button",{type:"button",class:"random-color-btn",onClick:Q,disabled:f.value,title:"Slumpa färg"}," 🎲 ",8,Rt)]),P[9]||(P[9]=t("small",{class:"input-help"},"Välj en färg för din bandvagn eller slumpa en",-1))]),t("div",Et,[P[10]||(P[10]=t("label",{class:"form-label"},"Förvalda färger:",-1)),t("div",Ft,[(h(),g(me,null,be(S,G=>t("button",{key:G,type:"button",class:H(["preset-color-btn",{active:p.value===G}]),style:fe({backgroundColor:G}),onClick:Y=>p.value=G,disabled:f.value},null,14,Lt)),64))])]),r.value?(h(),g("div",Ut,k(r.value),1)):I("",!0),f.value?(h(),g("div",Bt,[...P[11]||(P[11]=[t("div",{class:"loading-spinner"},"⏳",-1),t("p",null,"Skapar din bandvagn...",-1)])])):I("",!0),f.value?I("",!0):(h(),g("div",Yt,[t("button",{type:"button",onClick:K,class:"button-base decline"},"Avbryt"),P[12]||(P[12]=t("button",{type:"submit",class:"button-base"},"Skapa Bandvagn",-1))]))],32)):I("",!0),de(n).isAuthed&&l.value?(h(),g("div",Gt,[P[13]||(P[13]=t("hr",{class:"divider"},null,-1)),P[14]||(P[14]=t("p",null,"Eller om du redan har en bandvagn:",-1)),t("button",{onClick:ne,class:"button-base",disabled:f.value}," Logga in befintlig spelare ",8,Xt)])):I("",!0)])])]))]))}},Kt=ke(zt,[["__scopeId","data-v-917e64e0"]]),Ot={class:"popup-header"},qt={key:0,class:"players-section"},Vt={class:"player-list"},Wt={class:"player-info"},jt={class:"player-name"},Ht={class:"player-stats"},Nt={class:"action-buttons"},Zt={key:0,class:"action-option"},Jt=["disabled"],Qt={class:"btn-cost"},ea={key:1,class:"action-option"},ta={key:0},aa=["disabled"],sa={class:"btn-text"},na={key:2,class:"no-actions"},oa={key:0},la={key:1},ra={key:2},ia={key:3},ua={key:4},da={key:5},ca={class:"info-section"},va={class:"distance-info"},fa={key:0},ha={class:"cell-type-info"},pa={key:0,class:"status-danger"},ga={__name:"GamePopup",props:{cell:{type:Object,required:!0,validator:e=>e&&typeof e.row=="number"&&typeof e.col=="number"},currentPlayer:{type:Object,default:null},otherPlayers:{type:Array,default:()=>[]},canMove:{type:Boolean,default:!1},canShoot:{type:Boolean,default:!1},position:{type:Object,default:()=>({x:0,y:0})}},emits:["action","close"],setup(e,{emit:o}){const n=e,s=o,u=A(!1),p=E(()=>({left:`${n.position.x}px`,top:`${n.position.y}px`})),f=E(()=>n.otherPlayers.filter(U=>U.lives>0)),r=E(()=>!n.currentPlayer||!n.cell?0:Math.abs(n.cell.row-n.currentPlayer.position.row)+Math.abs(n.cell.col-n.currentPlayer.position.column)),_=E(()=>Math.max(1,r.value)),w=E(()=>n.currentPlayer?n.currentPlayer.tokens>=_.value:!1),l=E(()=>n.currentPlayer?n.currentPlayer.tokens>=1:!1),S=E(()=>!0),M=E(()=>n.otherPlayers.some(U=>U.taken_tank));async function F(U,T=null){if(u.value){console.log("Action already in progress, ignoring click");return}u.value=!0;try{const B={action:U,tank_id:n.currentPlayer?.uuid||"",targetCell:U==="move"?{row:n.cell.row,col:n.cell.col}:void 0,targetUUID:T};await s("action",B)}catch(B){console.error("Error performing action:",B)}finally{setTimeout(()=>{u.value=!1},1e3)}}return(U,T)=>e.cell?(h(),g("div",{key:0,class:"game-popup",style:fe(p.value)},[t("button",{class:"popup-close",onClick:T[0]||(T[0]=B=>U.$emit("close"))},"×"),t("div",Ot,[t("h4",null,"Cell ("+k(e.cell.row)+", "+k(e.cell.col)+")",1)]),e.otherPlayers.length>0?(h(),g("div",qt,[t("div",Vt,[(h(!0),g(me,null,be(e.otherPlayers,B=>(h(),g("div",{key:B.uuid,class:H(["player-item",{dead:B.lives<=0}])},[t("div",{class:"player-color",style:fe({backgroundColor:B.color})},null,4),t("div",Wt,[t("span",jt,k(B.playerID),1),t("span",Ht,k(B.lives)+" liv, "+k(B.tokens)+" tokens",1)])],2))),128))])])):I("",!0),t("div",Nt,[e.canMove?(h(),g("div",Zt,[t("button",{onClick:T[1]||(T[1]=B=>F("move")),class:H(["action-btn move-btn",{disabled:!w.value||u.value}]),disabled:!w.value||u.value},[T[3]||(T[3]=t("span",{class:"btn-icon"},"🚶‍♂️",-1)),T[4]||(T[4]=t("span",{class:"btn-text"},"Flytta Hit",-1)),t("span",Qt,k(_.value)+" token"+k(_.value>1?"s":""),1)],10,Jt)])):I("",!0),e.canShoot&&f.value.length>0?(h(),g("div",ea,[f.value.length===1?(h(),g("div",ta,[t("button",{onClick:T[2]||(T[2]=B=>F("shot",f.value[0].uuid)),class:H(["action-btn shoot-btn",{disabled:!l.value||u.value}]),disabled:!l.value||u.value},[T[5]||(T[5]=t("span",{class:"btn-icon"},"🎯",-1)),t("span",sa,"Skjut "+k(f.value[0].playerID),1),T[6]||(T[6]=t("span",{class:"btn-cost"},"1 token",-1))],10,aa)])):I("",!0)])):I("",!0),!e.canMove&&!e.canShoot?(h(),g("div",na,[e.currentPlayer?e.currentPlayer.lives<=0?(h(),g("p",la,"Du är död och kan inte utföra handlingar")):!w.value&&r.value>0?(h(),g("p",ra," Du har inte råd att flytta hit ("+k(_.value)+" tokens behövs, du har "+k(e.currentPlayer.tokens)+") ",1)):M.value&&e.otherPlayers.length===0?(h(),g("p",ia," Du kan inte flytta till din egen position ")):M.value?(h(),g("p",ua,"Cell upptagen av annan spelare")):(h(),g("p",da,"Ingen giltig handling")):(h(),g("p",oa,"Du måste vara inloggad för att spela"))])):I("",!0)]),t("div",ca,[t("div",va,[t("span",null,"Avstånd: "+k(r.value),1),e.currentPlayer&&e.otherPlayers.length>0?(h(),g("span",fa,"Räckvidd: "+k(e.currentPlayer.range),1)):I("",!0)]),t("div",ha,[S.value?I("",!0):(h(),g("span",pa,"⚠️ Avstängd zon"))])])],4)):I("",!0)}},ya=ke(ga,[["__scopeId","data-v-d0d0ac49"]]);function ma(e,o,n,s="explosion",u){const p=[],f=s==="explosion"?25:10,r=["#FFD700","#FF4500","#FF6347","#DC143C","#8B0000","#000000"];for(let w=0;w<f;w++){const l=Math.random()*Math.PI*2,S=n*(.07+Math.random()*.16);p.push({x:0,y:0,vx:Math.cos(l)*S,vy:Math.sin(l)*S,size:Math.max(2,n*.08+Math.random()*(n*.06)),color:r[Math.floor(Math.random()*r.length)]||"#FF4500",life:1,maxLife:400+Math.random()*300})}const _={row:e,col:o,type:s,particles:p,active:!0,duration:800,elapsed:0};return u&&(_.onComplete=u),_}function ba(e,o,n,s,u="click"){const p=[];for(let r=0;r<50;r++){const _=r/50*Math.PI*2+(Math.random()-.5)*.5,w=n*(.06+Math.random()*.16);p.push({x:0,y:0,vx:Math.cos(_)*w,vy:Math.sin(_)*w,size:Math.max(1.5,n*.06+Math.random()*(n*.04)),color:s,life:1,maxLife:300+Math.random()*250})}return{row:e,col:o,type:u,particles:p,active:!0,duration:350,elapsed:0,rippleRadius:0,rippleMaxRadius:Math.max(n*.9,14),rippleAlpha:1,playerColor:s}}function ka(e,o,n,s,u){const p=Math.sqrt(Math.pow(n-e,2)+Math.pow(s-o,2)),r=12/Math.max(1,p),_={startX:e,startY:o,endX:n,endY:s,currentX:e,currentY:o,progress:0,active:!0,speed:r};return u&&(_.onComplete=u),_}function _a(e,o,n,s,u,p=2,f){const r={startRow:e,startCol:o,endRow:n,endCol:s,currentRow:e,currentCol:o,tankUuid:u,phase:e!==n?"row":"col",progress:0,active:!0,speed:p};return f&&(r.onComplete=f),r}function wa(e,o){if(!e.active)return e;const n=e.active;return e.elapsed+=o,e.particles.forEach(s=>{s.x+=s.vx,s.y+=s.vy,s.life-=o/s.maxLife,s.vy+=.001*o,s.vx*=.98,s.vy*=.98}),e.particles=e.particles.filter(s=>s.life>0),(e.elapsed>=e.duration||e.particles.length===0)&&(e.active=!1,n&&e.onComplete&&e.onComplete()),e}function Pa(e,o){if(!e.active)return e;e.elapsed+=o;const n=e.elapsed/e.duration;if(n>=1)return e.active=!1,e;const s=1-Math.pow(1-n,3);return e.rippleRadius=s*e.rippleMaxRadius,e.rippleAlpha=1-s,e.particles.forEach(u=>{u.life-=o/u.maxLife,u.x+=u.vx,u.y+=u.vy,u.vx*=.985,u.vy*=.985}),e.particles=e.particles.filter(u=>u.life>0),e}function Ma(e,o){if(!e.active)return e;const n=e.progress>=1;return e.progress+=e.speed*o*.01,e.progress>=1&&(e.progress=1,e.active=!1,!n&&e.onComplete&&e.onComplete()),e.currentX=e.startX+(e.endX-e.startX)*e.progress,e.currentY=e.startY+(e.endY-e.startY)*e.progress,e}function Ca(e,o){if(!e.active)return e;e.progress>=1&&e.phase==="col"&&(e.currentRow,e.endRow);const n=e.speed*o*.001;if(e.phase==="row"){const s=Math.abs(e.endRow-e.startRow);s===0?(e.phase="col",e.progress=0):(e.progress+=n/s,e.progress>=1?(e.progress=1,e.currentRow=e.endRow,e.endCol!==e.startCol?(e.phase="col",e.progress=0):(e.active=!1,e.onComplete&&e.onComplete())):e.currentRow=e.startRow+(e.endRow-e.startRow)*e.progress)}else if(e.phase==="col"){const s=Math.abs(e.endCol-e.startCol);s===0?(e.active=!1,e.onComplete&&e.onComplete()):(e.progress+=n/s,e.progress>=1?(e.progress=1,e.currentCol=e.endCol,e.active=!1,e.onComplete&&e.onComplete()):e.currentCol=e.startCol+(e.endCol-e.startCol)*e.progress)}return e}function Ge(){return{explosions:[],bullets:[],clicks:[],tankMoves:[],lastUpdate:performance.now()}}function Sa(e,o=performance.now()){const n=o-e.lastUpdate;return e.explosions=e.explosions.map(s=>wa(s,n)).filter(s=>s.active),e.clicks=e.clicks.map(s=>Pa(s,n)).filter(s=>s.active),e.bullets=e.bullets.map(s=>Ma(s,n)).filter(s=>s.active),e.tankMoves=e.tankMoves.map(s=>Ca(s,n)).filter(s=>s.active),e.lastUpdate=o,e}function Da(e,o,n,s,u="explosion",p){return pe(e)||(e.lastUpdate=performance.now()),e.explosions.push(ma(o,n,s,u,p)),e}function Xe(e,o,n,s,u){return pe(e)||(e.lastUpdate=performance.now()),e.clicks.push(ba(o,n,s,u)),e}function Aa(e,o,n,s,u,p=.05,f){return pe(e)||(e.lastUpdate=performance.now()),e.bullets.push(ka(o,n,s,u,f)),e}function $a(e,o,n,s,u,p,f=2,r){return pe(e)||(e.lastUpdate=performance.now()),e.tankMoves.push(_a(o,n,s,u,p,f,r)),e}function pe(e){return e.explosions.length>0||e.bullets.length>0||e.clicks.length>0||e.tankMoves.length>0}function Ta(e,o,n,s,u,p){o.explosions.forEach(f=>{const r=(f.col+.5)*n,_=(f.row+.5)*n;f.particles.forEach(w=>{const l=r+w.x,S=_+w.y,M=(l+u)*s,F=(S+p)*s,U=w.size*s*(.85+.35*w.life);e.save(),e.globalAlpha=Math.max(0,Math.min(1,w.life)),e.fillStyle=w.color,e.beginPath(),e.arc(M,F,U,0,Math.PI*2),e.fill(),e.restore()})}),o.clicks.forEach(f=>{const r=(f.col+.5)*n,_=(f.row+.5)*n;if(f.rippleAlpha>0){const w=(r+u)*s,l=(_+p)*s,S=f.rippleRadius*s;e.save(),e.strokeStyle=`rgba(224, 59, 75, ${Math.max(0,Math.min(.9,f.rippleAlpha))})`,e.lineWidth=Math.max(1,f.rippleAlpha*4),e.beginPath(),e.arc(w,l,S,0,Math.PI*2),e.stroke(),e.restore()}f.particles.forEach(w=>{const l=r+w.x,S=_+w.y,M=(l+u)*s,F=(S+p)*s,U=w.size*s*(.85+.35*w.life);e.save(),e.globalAlpha=Math.max(0,Math.min(1,w.life)),e.fillStyle=w.color,e.beginPath(),e.arc(M,F,U,0,Math.PI*2),e.fill(),e.restore()})}),o.bullets.forEach(f=>{const r=(f.currentX+u)*s,_=(f.currentY+p)*s,w=Math.max(2,n*.1)*s;e.save(),e.fillStyle="#000000",e.beginPath(),e.arc(r,_,w,0,Math.PI*2),e.fill(),e.restore()})}function Ia(e,o){const n=e.tankMoves.find(s=>s.tankUuid===o&&s.active);return n?{row:n.currentRow,col:n.currentCol}:null}const xa={class:"canvas-controls"},Ra={key:1,class:"loading-overlay"},ze=4,Ke=16/24,Ea=ft({__name:"BandvagnCanvas",emits:["actionPerformed"],setup(e,{expose:o,emit:n}){const s=De(),u=n,p=A(null),f=A(null),r=A(null),_=A(800),w=A(600),l=A(30),S=A(1),M=A({x:0,y:0}),F=A(!1),U=A(!1),T=A({x:0,y:0}),B=A(!1),W=A(window.devicePixelRatio||1),ne=A(null),K=A(!1),Q=A({x:0,y:0}),D=A(null),P=A(0),G=A(!1),Y=A(Ge());let O=null;const L=E(()=>s.allPlayers.find(a=>a.uuid===s.currentPlayer?.uuid)||null),ie=E(()=>s.allPlayers),q=E(()=>(console.log("gameStore.boardData",s.boardData),s.boardData?{rows:s.boardData.rows,cols:s.boardData.cols}:{rows:0,cols:0})),oe=E(()=>{const a=s.boardData?.shrink||0;return{rows:Math.max(1,q.value.rows-a*2),cols:Math.max(1,q.value.cols-a*2),shrink:a}}),le=E(()=>D.value?s.allPlayers.filter(a=>a.position.row===D.value.row&&a.position.column===D.value.col&&a.uuid!==s.currentPlayer?.uuid):[]),b=E(()=>!D.value||!s.currentPlayer?!1:s.canMoveToCell(D.value.row,D.value.col)),d=E(()=>{if(!D.value||!s.currentPlayer||le.value.filter(y=>y.lives>0).length===0)return!1;const{row:i,col:c}=D.value,v=Math.abs(i-L.value.position.row)+Math.abs(c-L.value.position.column);return v<=L.value.range&&v>0&&L.value.tokens>=1});function m(a){let i=a.clientWidth,c=a.clientHeight;if(!i||!c){const v=a.getBoundingClientRect(),y=getComputedStyle(a),$=parseFloat(y.borderLeftWidth||"0")+parseFloat(y.borderRightWidth||"0"),x=parseFloat(y.borderTopWidth||"0")+parseFloat(y.borderBottomWidth||"0");i=Math.max(0,Math.floor(v.width-$)),c=Math.max(0,Math.floor(v.height-x))}return{width:i,height:c}}function ee(){const a=f.value,i=p.value;if(!a||!i)return;const{width:c,height:v}=m(i),y=Math.max(1,Math.floor(c)),$=Math.max(1,Math.floor(v));y===_.value&&$===w.value||(_.value=y,w.value=$,W.value=window.devicePixelRatio||1,a.width=Math.floor(_.value*W.value),a.height=Math.floor(w.value*W.value),r.value=a.getContext("2d"),r.value&&(r.value.setTransform(W.value,0,0,W.value,0,0),r.value.imageSmoothingEnabled=!1,l.value=30,V()))}function V(){r.value&&(q.value.rows<=0||q.value.cols<=0||(r.value.clearRect(0,0,_.value,w.value),r.value.save(),r.value.scale(S.value,S.value),r.value.translate(M.value.x,M.value.y),je(),_e(),D.value&&Ne(D.value.row,D.value.col),L&&Ze(),r.value.restore(),He()))}function _e(){for(const a of ie.value){const c=Ia(Y.value,a.uuid)||{row:a.position.row,col:a.position.column},v=c.col*l.value,y=c.row*l.value,$=a.taken_tank,x=a.lives>0;if(we(r.value,v,y,l.value,a.color,x,$,a.uuid===L.value?.uuid),a.uuid===L.value?.uuid){const C=p.value??document.documentElement;r.value.strokeStyle=getComputedStyle(C).getPropertyValue("--modal-header-color").trim(),r.value.lineWidth=3,r.value.beginPath(),r.value.arc(v+l.value/2,y+l.value/2,l.value/2,0,Math.PI*2),r.value.stroke()}if(a.lives>0)if(a.lives>3)r.value.fillStyle="#e74c3c",r.value.font=`${Math.floor(l.value*.3)}px Arial`,r.value.textAlign="left",r.value.textBaseline="top",r.value.fillText(`${a.lives}❤`,v,y+1);else{r.value.fillStyle="#e74c3c";const C=l.value/8;for(let R=0;R<a.lives;R++){const j=v+5+R*(C+2),Z=y+5;r.value.fillRect(j,Z,C,C)}}}}function we(a,i,c,v,y,$,x,C){a.save(),a.imageSmoothingEnabled=!1;const R=$?Math.min(1,Math.max(.4,(x?.7:.5)+.15)):.1;a.globalAlpha=R;const j=ne.value;if(j&&j.complete&&j.naturalWidth>0&&j.naturalHeight>0){const Z=Math.max(1,v*.08);let ae=v-Z*2,se=ae*Ke;se>v-Z*2&&(se=v-Z*2,ae=se/Ke);const Pe=i+(v-se)/2,Me=c+(v-ae)/2,z=document.createElement("canvas");z.width=j.naturalWidth,z.height=j.naturalHeight;const X=z.getContext("2d");X.imageSmoothingEnabled=!1,X.clearRect(0,0,z.width,z.height),X.fillStyle=y,X.fillRect(0,0,z.width,z.height),X.globalCompositeOperation="multiply",X.drawImage(j,0,0),X.globalCompositeOperation="destination-in",X.drawImage(j,0,0),X.globalCompositeOperation="source-over",a.drawImage(z,Pe,Me,se,ae)}else{const Z=v*.8,ae=v*.55,se=i+(v-Z)/2,Pe=c+(v-ae)/2,Me=Math.max(2,v*.08);a.fillStyle=y,a.strokeStyle=$?"#222":"#999",a.lineWidth=Math.max(1,v*.06),We(a,se,Pe,Z,ae,Me),a.fill(),a.stroke();const z=v*.18,X=i+v/2,ue=c+v/2;a.beginPath(),a.arc(X,ue,z,0,Math.PI*2),a.fillStyle="#fff8",a.fill(),a.stroke();const ge=Math.max(2,v*.08),Fe=v*.35;a.beginPath(),a.moveTo(X-ge/2,ue-z),a.lineTo(X-ge/2,ue-z-Fe),a.lineTo(X+ge/2,ue-z-Fe),a.lineTo(X+ge/2,ue-z),a.closePath(),a.fillStyle="#222a",a.fill()}a.restore()}function We(a,i,c,v,y,$){const x=Math.min($,v/2,y/2);a.beginPath(),a.moveTo(i+x,c),a.lineTo(i+v-x,c),a.quadraticCurveTo(i+v,c,i+v,c+x),a.lineTo(i+v,c+y-x),a.quadraticCurveTo(i+v,c+y,i+v-x,c+y),a.lineTo(i+x,c+y),a.quadraticCurveTo(i,c+y,i,c+y-x),a.lineTo(i,c+x),a.quadraticCurveTo(i,c,i+x,c),a.closePath()}function je(){if(!r.value)return;const a=q.value.rows,i=q.value.cols,c=oe.value.shrink,v=p.value??document.documentElement,y=getComputedStyle(v),$=y.getPropertyValue("--canvas-bg-color").trim();r.value.fillStyle=$,r.value.save(),r.value.setTransform(1,0,0,1,0,0),r.value.fillRect(0,0,f.value.width,f.value.height),r.value.restore(),r.value.strokeStyle=y.getPropertyValue("--canvas-grid-color").trim(),r.value.lineWidth=.5;for(let C=0;C<=i;C++){const R=Math.floor(C*l.value);r.value.beginPath(),r.value.moveTo(R,0),r.value.lineTo(R,a*l.value),r.value.stroke()}for(let C=0;C<=a;C++){const R=Math.floor(C*l.value)+.5;r.value.beginPath(),r.value.moveTo(0,R),r.value.lineTo(i*l.value,R),r.value.stroke()}if(c>0){r.value.fillStyle="rgba(240, 60, 80, 0.3)";for(let C=0;C<=a-1;C++)for(let R=0;R<=i-1;R++)(C<c||C>=a-c||R<c||R>=i-c)&&r.value.fillRect(R*l.value,C*l.value,l.value,l.value)}const x=y.getPropertyValue("--canvas-text-color").trim()||"#444";r.value.fillStyle=x,r.value.font=`${Math.max(10,Math.floor(l.value*.35))}px Arial`,r.value.textAlign="center",r.value.textBaseline="top";for(let C=0;C<i;C++){const R=C*l.value+l.value/2;r.value.fillText(String(C),R,5-Math.min(M.value.y,l.value))}r.value.textAlign="left",r.value.textBaseline="middle";for(let C=0;C<a;C++){const R=C*l.value+l.value/2;r.value.fillText(String(C),5-Math.min(M.value.x,l.value),R)}}function He(){r.value&&(Y.value=Sa(Y.value),Ta(r.value,Y.value,l.value,S.value,M.value.x,M.value.y))}function N(){if(O!==null)return;const a=()=>{O=null,V(),pe(Y.value)?O=requestAnimationFrame(a):console.log("Stopping animation loop")};O=requestAnimationFrame(a)}function Ne(a,i){const c=i*l.value,v=a*l.value,y=p.value??document.documentElement;r.value.strokeStyle=getComputedStyle(y).getPropertyValue("--modal-header-color").trim(),r.value.lineWidth=3,r.value.setLineDash([5,5]),r.value.strokeRect(c,v,l.value,l.value),r.value.setLineDash([])}function Ze(){if(!L||!r.value)return;const a=L.value.range,i=L.value.position.row,c=L.value.position.column;r.value.fillStyle="rgba(76, 175, 80, 0.15)";for(let v=i-a;v<=i+a;v++)for(let y=c-a;y<=c+a;y++){const $=Math.abs(v-i)+Math.abs(y-c);if($<=a&&$>0&&v>=0&&y>=0&&v<q.value.rows&&y<q.value.cols){const x=y*l.value,C=v*l.value;r.value.fillRect(x,C,l.value,l.value)}}}function Je(a,i){const c=f.value.getBoundingClientRect(),v=(a-c.left)/S.value-M.value.x,y=(i-c.top)/S.value-M.value.y,$=Math.floor(v/l.value);return{row:Math.floor(y/l.value),col:$}}function Qe(a,i){const c=(i*l.value+M.value.x)*S.value,v=(a*l.value+M.value.y)*S.value;return{x:c,y:v}}function et(a){if(F.value||U.value)return;const{row:i,col:c}=Je(a.clientX,a.clientY);if(i<0||c<0||i>=q.value.rows||c>=q.value.cols)return;if(D.value&&D.value.row===i&&D.value.col===c){console.log("Cell clicked again, toggling popup off"),K.value=!K.value,D.value=null,V();return}D.value={row:i,col:c},console.log("Cell clicked:",i,c);const v=ie.value.find(x=>x.position.row===i&&x.position.column===c);v&&(Y.value=Xe(Y.value,i,c,l.value,v.color),N());const{x:y,y:$}=Qe(i,c);Q.value={x:Math.min(y+50,_.value-250),y:Math.max($-250,0)},K.value=!0,V()}function tt(a){F.value=!0,U.value=!1,T.value={x:a.clientX,y:a.clientY}}function at(a){if(!F.value)return;const i=a.clientX-T.value.x,c=a.clientY-T.value.y;(Math.abs(i)>ze||Math.abs(c)>ze)&&(U.value=!0),M.value.x+=i/S.value,M.value.y+=c/S.value,T.value={x:a.clientX,y:a.clientY},N()}function Ae(){F.value=!1}function st(a){const i=a.deltaY>0?.9:1.1,c=Math.max(.5,Math.min(3,S.value*i)),v=f.value.getBoundingClientRect(),y=a.clientX-v.left,$=a.clientY-v.top,x=y/S.value-M.value.x,C=$/S.value-M.value.y;M.value.x=y/c-x,M.value.y=$/c-C,S.value=c,N()}function nt(a){if(a.touches.length===1){const i=a.touches.item(0);T.value={x:i.clientX,y:i.clientY},F.value=!0,U.value=!1}else if(a.touches.length===2){G.value=!0;const i=a.touches.item(0),c=a.touches.item(1);P.value=Math.sqrt(Math.pow(c.clientX-i.clientX,2)+Math.pow(c.clientY-i.clientY,2))}}function ot(a){if(a.touches.length===1&&!G.value){const i=a.touches.item(0),c=i.clientX-T.value.x,v=i.clientY-T.value.y;(Math.abs(c)>5||Math.abs(v)>5)&&(M.value.x+=c/S.value,M.value.y+=v/S.value,V()),T.value={x:i.clientX,y:i.clientY},N()}else if(a.touches.length===2){const i=a.touches.item(0),c=a.touches.item(1),v=Math.sqrt(Math.pow(c.clientX-i.clientX,2)+Math.pow(c.clientY-i.clientY,2)),y=v/P.value,$=Math.max(.5,Math.min(3,S.value*y));S.value=$,P.value=v,N()}}function lt(){F.value=!1,G.value=!1}function rt(){S.value=1,M.value={x:0,y:0},V()}function $e(a){if(!a)return;console.log("Centering on player",a.name,a.position);const i=_.value/2,c=w.value/2;M.value.x=i/S.value-(a.position.column*l.value+l.value/2),M.value.y=c/S.value-(a.position.row*l.value+l.value/2),V()}function Te(a,i,c){Y.value=Da(Y.value,a,i,l.value,"explosion",c),N()}function Ie(a,i,c,v,y){const $=(i+.5)*l.value,x=(a+.5)*l.value,C=(v+.5)*l.value,R=(c+.5)*l.value;Y.value=Aa(Y.value,$,x,C,R,.05,y),N()}function xe(a,i,c,v,y,$){Y.value=$a(Y.value,i,c,v,y,a,2,()=>{Y.value=Xe(Y.value,v,y,l.value,L.value?.color||"#ffffff"),$&&$()}),N()}function it(a,i,c,v,y){Ie(a,i,c,v,()=>{Te(c,v,y)})}o({triggerExplosion:Te,triggerBullet:Ie,triggerBulletAndExplosion:it,triggerTankMove:xe,centerOnPlayer:$e});function ut(a){if(a.action==="move"&&L.value){const i=L.value.position.row,c=L.value.position.column,v=a.targetCell.row,y=a.targetCell.col,$={...a,animationTrigger:{triggerTankMove:x=>{xe(L.value.uuid,i,c,v,y,x)}}};u("actionPerformed",$)}else u("actionPerformed",a);Re()}function Re(){K.value=!1,D.value=null}let te=null;function Ee(){te!==null&&cancelAnimationFrame(te),te=requestAnimationFrame(()=>{te=null,ee()})}return Oe([()=>ie,()=>s.boardData,()=>L],()=>{ht(()=>{V()})},{deep:!0}),Se(()=>{ee(),window.addEventListener("resize",Ee);const a=new Image;a.src="/assets/bandvagn no shadow.png",a.decoding="async",a.onload=()=>{ne.value=a,V()}}),qe(()=>{te!==null&&(cancelAnimationFrame(te),te=null),window.removeEventListener("resize",Ee),O!==null&&(cancelAnimationFrame(O),O=null),Y.value=Ge()}),(a,i)=>(h(),g("div",{class:"canvas-container",ref_key:"containerRef",ref:p},[t("canvas",{ref_key:"canvasRef",ref:f,class:"game-canvas",onClick:et,onMousedown:tt,onMousemove:at,onMouseup:Ae,onMouseleave:Ae,onWheel:ce(st,["prevent"]),onTouchstart:ce(nt,["prevent"]),onTouchmove:ce(ot,["prevent"]),onTouchend:ce(lt,["prevent"])},null,544),K.value&&D.value?(h(),ye(ya,{key:0,cell:D.value,"current-player":L.value,"other-players":le.value,"can-move":b.value,"can-shoot":d.value,position:Q.value,onAction:ut,onClose:Re},null,8,["cell","current-player","other-players","can-move","can-shoot","position"])):I("",!0),t("div",xa,[t("button",{onClick:rt,class:"control-btn",title:"Reset zoom"},"(0,0)"),L.value?(h(),g("button",{key:0,onClick:i[0]||(i[0]=c=>$e(L.value)),class:"control-btn",title:"Center on player"}," 🎯 ")):I("",!0)]),B.value?(h(),g("div",Ra,[...i[1]||(i[1]=[t("div",{class:"loading-spinner"},"⏳",-1),t("p",null,"Laddar spel...",-1)])])):I("",!0)],512))}}),Fa=ke(Ea,[["__scopeId","data-v-45094ec3"]]),La={id:"app-container"},Ua={class:"stats-container"},Ba={class:"stats-content"},Ya={key:0,class:"stats-grid"},Ga={class:"stat-item"},Xa={class:"stat-value"},za={class:"stat-item"},Ka={class:"stat-value"},Oa={class:"stat-item"},qa={class:"stat-value"},Va={class:"stat-item"},Wa={class:"stat-value"},ja={key:1,class:"no-player-message"},Ha={key:2,class:"players-list"},Na={class:"players-list-header"},Za={class:"players-list-items"},Ja={class:"player-name"},Qa={class:"player-position"},es={class:"player-distance"},ts={class:"player-focus"},as=["onClick"],ss={class:"player-meta"},ns={class:"mobile-controls-bar"},os={class:"mobile-top-row"},ls={key:0,class:"mobile-game-info"},rs={class:"mobile-tokens"},is={class:"mobile-lives"},us={class:"mobile-btn-container"},ds=["disabled"],cs={key:0},vs={key:1},fs={class:"game-layout"},hs={class:"sidebar desktop-only"},ps={class:"sidebar-btn-container"},gs=["disabled"],ys={key:0},ms={key:1},bs={key:0},ks={key:1},_s={key:0,class:"action-buttons"},ws=["disabled"],Ps=["disabled"],Ms={class:"canvas-outer-wrapper"},Cs={class:"canvas-container"},Ss={key:1,class:"upgrade-modal auth-form"},Ds={class:"form-base"},As={key:0},$s={key:1},Ts={key:3,class:"loading-container"},Is={key:4,class:"no-player-container"},xs={key:0,class:"mobile-actions"},Rs=["disabled"],Es=["disabled"],Fs={class:"sidebar desktop-only"},Ls={key:0,class:"game-info"},Us={class:"info-item"},Bs={class:"info-value"},Ys={class:"info-item"},Gs={class:"info-value"},Xs={class:"info-item"},zs={class:"info-value"},Ks={class:"info-item"},Os={class:"info-value"},qs={class:"info-item"},Vs={key:1,class:"game-logs"},Ws={class:"logs-container"},js={class:"log-header"},Hs={class:"log-timestamp"},Ns={class:"log-content"},Zs={class:"log-action"},Js={key:0,class:"mobile-stats"},Qs={class:"mobile-stats-grid"},en={class:"mobile-stat-item"},tn={class:"mobile-stat-value"},an={class:"mobile-stat-item"},sn={key:1,class:"information-container"},nn={__name:"Kfkbandvagn",setup(e){const o=A(null),n=re(),s=De(),u=A(!1),p=A(!1),f=A(!1),r=A(!1),_=A(""),w=A(!1),l=E(()=>s.currentPlayer),S=E(()=>s.allPlayers),M=E(()=>s.boardData),F=E(()=>s.isLoading);E(()=>s.initialized&&l.value);function U(){return console.log("Checking game initialized:",s.initialized,l.value),s.initialized&&l.value}const T=E(()=>S.value.filter(d=>d.taken_tank).map(d=>({...d,distToCurrent:l.value?Math.abs(d.position.row-l.value.position.row)+Math.abs(d.position.column-l.value.position.column):1/0})).sort((d,m)=>d.distToCurrent-m.distToCurrent)),B=E(()=>M.value?.logs?M.value.logs.slice().reverse():[]);function W(){u.value=!u.value}function ne(){p.value=!p.value}async function K(){try{await s.fetchGameState()}catch(b){console.error("Failed to refresh game state:",b)}}function Q(){f.value=!0}function D(){f.value=!1}function P(){f.value=!1,K()}function G(b){o.value.centerOnPlayer(b)}async function Y(b){try{b.action==="shot"&&o.value&&(b.animationTrigger={triggerBulletAndExplosion:o.value.triggerBulletAndExplosion}),await s.performAction(b)}catch(d){console.error("Action failed:",d)}}function O(b){_.value=b,r.value=!0}function L(){r.value=!1,_.value=""}async function ie(){console.log("Confirming upgrade:",_.value);try{await s.performAction({action:_.value,tank_id:l.value?.uuid||""}),r.value=!1,_.value="",console.log("Upgrade successful")}catch(b){console.error("Upgrade failed:",b)}}function q(b){const d=new Date(b),m=d.getFullYear().toString().slice(-2),ee=String(d.getMonth()+1).padStart(2,"0"),V=String(d.getDate()).padStart(2,"0"),_e=String(d.getHours()).padStart(2,"0"),we=String(d.getMinutes()).padStart(2,"0");return`${m}-${ee}-${V} ${_e}:${we}`}function oe(b){const d=l.value&&b.playerID===l.value.playerID;let m="";switch(b.action){case"shot":b.details?.targetUser?m=`Sköt ${b.details.targetUser} (${b.details.targetUserLives} liv kvar)`:m="Sköt";break;case"move":b.details?.position?m=`Flyttade till (${b.details.position.row}, ${b.details.position.column})`:m="Flyttade";break;case"range":b.details?.range?m=`Köpte räckvidd (${b.details.range-1} → ${b.details.range})`:m="Köpte räckvidd";break;case"life":b.details?.lives?m=`Köpte liv (${b.details.lives-1} → ${b.details.lives})`:m="Köpte liv";break;case"board_shrink":m="Spelplanen krympte";break;case"token_distribution":b.details?.tokensGiven?m=`Alla fick ${b.details.tokensGiven} tokens`:m="Alla fick tokens";break;case"death":b.details?.targetUser?m=`${b.details.targetUser} dog`:m="Någon dog";break;case"respawn":m="Återuppstod";break;default:m=b.action;break}return{timestamp:q(b.timestamp),playerID:b.playerID,actionDescription:m,isCurrentPlayer:d}}function le(){w.value=window.innerWidth<=768}return Oe(()=>n.authStateVersion,async(b,d)=>{if(console.log(`Auth state version changed: ${d} -> ${b}`),n.isAuthed){console.log("User authenticated, initializing game store");try{await s.initialize(),l.value?f.value=!1:f.value=!0}catch(m){console.error("Failed to initialize game store after auth change:",m)}}else console.log("User logged out, resetting game store"),s.reset(),f.value=!1},{immediate:!1}),Se(async()=>{if(le(),window.addEventListener("resize",le),document.addEventListener("visibilitychange",async()=>{if(console.log("Document visibility changed:",document.visibilityState),document.visibilityState==="visible")try{const{data:b,error:d}=await Ce.auth.refreshSession();d?console.warn("Session refresh failed:",d):console.log("Session refreshed successfully")}catch(b){console.error("Error refreshing session:",b)}}),n.isAuthed){console.log("User authenticated, initializing game store");try{await s.initialize()}catch(b){console.error("Failed to initialize game store on mount:",b)}}}),qe(()=>{window.removeEventListener("resize",le)}),(b,d)=>(h(),g("div",La,[d[30]||(d[30]=t("h1",{class:"game-header"},"KfKbandvagn",-1)),t("div",Ua,[t("button",{onClick:ne,class:"stats-toggle"},[d[4]||(d[4]=t("span",null,"Spelstatus",-1)),t("span",{class:H(["toggle-icon",{expanded:p.value}])},"▼",2)]),t("div",{class:H(["stats-wrapper",{expanded:p.value}])},[t("div",Ba,[l.value?(h(),g("div",Ya,[t("div",Ga,[d[5]||(d[5]=t("span",{class:"stat-label"},"Spelare",-1)),t("span",Xa,k(l.value.playerID),1)]),t("div",za,[d[6]||(d[6]=t("span",{class:"stat-label"},"Tokens",-1)),t("span",Ka,k(l.value.tokens),1)]),t("div",Oa,[d[7]||(d[7]=t("span",{class:"stat-label"},"Liv",-1)),t("span",qa,k(l.value.lives),1)]),t("div",Va,[d[8]||(d[8]=t("span",{class:"stat-label"},"Räckvidd",-1)),t("span",Wa,k(l.value.range),1)])])):(h(),g("div",ja,[...d[9]||(d[9]=[t("p",null,"Ingen aktiv spelare - logga in eller skapa en bandvagn",-1)])])),T.value.length?(h(),g("div",Ha,[t("div",Na,[t("span",null,"Spelare på brädet ("+k(T.value.length)+")",1)]),t("ul",Za,[d[10]||(d[10]=Be('<li style="border-bottom:1px solid var(--theme-border-light);" data-v-5d2622d5><span class="players-list-header" data-v-5d2622d5>Namn</span><span class="players-list-header" data-v-5d2622d5>Position (r,c)</span><span class="players-list-header" data-v-5d2622d5>Distans</span><span class="players-list-header" data-v-5d2622d5>Visa</span><span data-v-5d2622d5></span></li>',1)),(h(!0),g(me,null,be(T.value,m=>(h(),g("li",{key:m.uuid,class:"players-list-item"},[t("div",null,[m.uuid===l.value?.uuid?(h(),g("span",{key:0,class:"current-player-indicator",style:fe({color:m.color,background:"#ffd70099",borderRadius:"5px"})},"★",4)):I("",!0),m.uuid!==l.value?.uuid?(h(),g("span",{key:1,class:"player-dot",style:fe({backgroundColor:m.color})},null,4)):I("",!0),t("span",Ja,k(m.playerID),1)]),t("span",Qa,k(m.position.row)+", "+k(m.position.column),1),t("span",es,k(m.distToCurrent),1),t("span",ts,[t("button",{onClick:ee=>G(m)},"🔍",8,as)]),t("span",ss,"❤ "+k(m.lives)+" · ➶ "+k(m.range)+" · ⛁ "+k(m.tokens),1)]))),128))])])):I("",!0)])],2)]),t("div",ns,[t("div",os,[l.value?(h(),g("div",ls,[t("span",rs,k(l.value.tokens)+" tokens",1),t("span",is,k(l.value.lives)+" liv",1)])):I("",!0),t("div",us,[t("button",{onClick:K,class:"mobile-btn",disabled:F.value},[F.value?(h(),g("span",cs,"⏳")):(h(),g("span",vs,"🔄"))],8,ds),t("button",{onClick:W,class:"mobile-btn"},"ℹ️")])])]),t("div",fs,[t("div",hs,[t("div",ps,[t("button",{onClick:K,class:"sidebar-btn",disabled:F.value},[F.value?(h(),g("span",ys,"Laddar...")):(h(),g("span",ms,"Uppdatera"))],8,gs),t("button",{onClick:W,class:"sidebar-btn"},[u.value?(h(),g("span",bs,"Dölj Info")):(h(),g("span",ks,"Visa Info"))])]),l.value&&l.value.lives>0?(h(),g("div",_s,[t("button",{onClick:d[0]||(d[0]=m=>O("range")),class:"action-btn",disabled:l.value.tokens<3},[...d[11]||(d[11]=[J(" Köp Räckvidd ",-1),t("br",null,null,-1),J(" (3 tokens) ",-1)])],8,ws),t("button",{onClick:d[1]||(d[1]=m=>O("life")),class:"action-btn",disabled:l.value.tokens<3},[...d[12]||(d[12]=[J(" Köp Liv ",-1),t("br",null,null,-1),J(" (3 tokens) ",-1)])],8,Ps)])):I("",!0)]),t("div",Ms,[t("div",Cs,[f.value?(h(),ye(Kt,{key:0,onClose:D,onPlayerCreated:P})):I("",!0),r.value?(h(),g("div",Ss,[t("div",Ds,[d[17]||(d[17]=t("h3",null,"Bekräfta Köp",-1)),_.value==="range"?(h(),g("p",As,[d[13]||(d[13]=J(" Vill du köpa ökad räckvidd för 3 tokens?",-1)),d[14]||(d[14]=t("br",null,null,-1)),J(" Din nuvarande räckvidd: "+k(l.value?.range||0),1)])):I("",!0),_.value==="life"?(h(),g("p",$s,[d[15]||(d[15]=J(" Vill du köpa ett extra liv för 3 tokens?",-1)),d[16]||(d[16]=t("br",null,null,-1)),J(" Dina nuvarande liv: "+k(l.value?.lives||0),1)])):I("",!0),t("div",{class:"button-group"},[t("button",{onClick:L,class:"button-base decline"},"Avbryt"),t("button",{onClick:ie,class:"button-base"},"Köp")])])])):I("",!0),U()?(h(),ye(Fa,{key:2,ref_key:"canvasRef",ref:o,onActionPerformed:Y},null,512)):F.value?(h(),g("div",Ts,[...d[18]||(d[18]=[t("div",{class:"loading-spinner"},"⏳",-1),t("p",null,"Laddar spel...",-1)])])):(h(),g("div",Is,[d[19]||(d[19]=t("h2",null,"Välkommen till KfKbandvagn!",-1)),d[20]||(d[20]=t("p",null,"Du behöver logga in och skapa en bandvagn för att spela.",-1)),t("button",{onClick:Q,class:"button-base"},"Skapa Bandvagn")]))]),l.value&&l.value.lives>0?(h(),g("div",xs,[t("button",{onClick:d[2]||(d[2]=m=>O("range")),class:"mobile-action-btn",disabled:l.value.tokens<3}," Räckvidd (3t) ",8,Rs),t("button",{onClick:d[3]||(d[3]=m=>O("life")),class:"mobile-action-btn",disabled:l.value.tokens<3}," Liv (3t) ",8,Es)])):I("",!0)]),t("div",Fs,[l.value?(h(),g("div",Ls,[t("div",Us,[d[21]||(d[21]=t("span",{class:"info-label"},"Position",-1)),t("span",Bs,k(l.value.position.row)+", "+k(l.value.position.column),1)]),t("div",Ys,[d[22]||(d[22]=t("span",{class:"info-label"},"Tokens",-1)),t("span",Gs,k(l.value.tokens),1)]),t("div",Xs,[d[23]||(d[23]=t("span",{class:"info-label"},"Liv",-1)),t("span",zs,k(l.value.lives),1)]),t("div",Ks,[d[24]||(d[24]=t("span",{class:"info-label"},"Räckvidd",-1)),t("span",Os,k(l.value.range),1)]),t("div",qs,[d[25]||(d[25]=t("span",{class:"info-label"},"Status",-1)),t("span",{class:H(["info-value",{dead:l.value.lives<=0}])},k(l.value.lives>0?"Levande":"Död"),3)])])):I("",!0),M.value&&M.value.logs?(h(),g("div",Vs,[d[26]||(d[26]=t("h4",null,"Senaste Händelser",-1)),t("div",Ws,[(h(!0),g(me,null,be(B.value,(m,ee)=>(h(),g("div",{key:ee,class:"log-entry"},[t("div",js,[t("span",Hs,k(oe(m).timestamp),1),t("span",{class:H(["log-player",{"current-player":oe(m).isCurrentPlayer}])},k(oe(m).playerID),3)]),t("div",Ns,[t("span",Zs,k(oe(m).actionDescription),1)])]))),128))])])):I("",!0)])]),l.value?(h(),g("div",Js,[t("div",Qs,[t("div",en,[d[27]||(d[27]=t("span",{class:"mobile-stat-label"},"Position",-1)),t("span",tn,k(l.value.position.row)+","+k(l.value.position.column),1)]),t("div",an,[d[28]||(d[28]=t("span",{class:"mobile-stat-label"},"Status",-1)),t("span",{class:H(["mobile-stat-value",{dead:l.value.lives<=0}])},k(l.value.lives>0?"Levande":"Död"),3)])])])):I("",!0),u.value?(h(),g("div",sn,[...d[29]||(d[29]=[Be('<div class="information-text" data-v-5d2622d5><div class="background-decor" data-v-5d2622d5><div class="information-inset" data-v-5d2622d5><strong data-v-5d2622d5>Spelregler</strong><p data-v-5d2622d5> Varje spelare börjar på en slumpmässig plats på spelplanen med 3 hjärtan (liv), 2 rutor i räckvidd och 0 Tokens. Tokens förelas automatiskt dagligen. Använd tokens för att utföra handlingar. </p></div></div><div class="background-decor" data-v-5d2622d5><div class="information-inset" data-v-5d2622d5><strong data-v-5d2622d5>Handlingar</strong><p data-v-5d2622d5><strong data-v-5d2622d5>Flytta:</strong> Klicka på en tom ruta för att flytta dit (1 token per ruta).<br data-v-5d2622d5><strong data-v-5d2622d5>Skjut:</strong> Klicka på en annan spelare inom din räckvidd för att skjuta (1 token). Om spelaren dör får du 5 tokens.<br data-v-5d2622d5><strong data-v-5d2622d5>Köp Räckvidd:</strong> Öka din räckvidd med 1 (3 tokens).<br data-v-5d2622d5><strong data-v-5d2622d5>Köp Liv:</strong> Få ett extra liv (3 tokens). </p></div></div><div class="background-decor" data-v-5d2622d5><div class="information-inset" data-v-5d2622d5><strong data-v-5d2622d5>Liv och Dödsfall</strong><p data-v-5d2622d5> Om du blir skjuten förlorar du ett liv. När du når 0 liv är du ute ur spelet (kom ihåg att köpa liv). Du kan återuppstå genom att en annan spelare donerar ett liv till dig. </p></div></div><div class="background-decor" data-v-5d2622d5><div class="information-inset" data-v-5d2622d5><strong data-v-5d2622d5>Spelplan</strong><p data-v-5d2622d5> Spelplanen krymper regelbundet och spelare utanför den aktiva ytan förlorar ett liv för varje gång spelplanen krymper. Nya tokens fördelas automatiskt till alla levande spelare. Planera dina drag väl! </p></div></div></div>',1)])])):I("",!0)]))}},ln=ke(nn,[["__scopeId","data-v-5d2622d5"]]);export{ln as default};
